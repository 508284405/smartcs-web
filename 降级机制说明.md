# ChatMemoryStore 降级机制说明

## 概述

本项目使用 `FaultTolerantRedisChatMemoryStore` 作为主要的聊天记忆存储实现，它提供了基于 Resilience4j 的容错机制，在 Redis 不可用时自动降级到内存存储。

## 架构设计

### 组件关系

```
FaultTolerantRedisChatMemoryStore (主要实现)
├── RedisChatMemoryStore (Redis存储实现)
└── InMemoryChatMemoryStore (内存降级存储)
```

### 工作流程

1. **正常情况**：所有操作直接通过 RedisChatMemoryStore 进行
2. **Redis故障**：自动降级到 InMemoryChatMemoryStore
3. **Redis恢复**：继续使用 Redis，内存中的数据作为备份

## 容错机制

### Resilience4j 组件

- **CircuitBreaker**：熔断器，防止级联故障
- **Retry**：重试机制，处理临时故障
- **Bulkhead**：限流器，控制并发访问
- **TimeLimiter**：超时控制，避免长时间等待

### 配置参数

```yaml
resilience4j:
  circuitbreaker:
    instances:
      redis-memory-store:
        sliding-window-size: 10
        minimum-number-of-calls: 5
        failure-rate-threshold: 50
        wait-duration-in-open-state: 60s
        permitted-number-of-calls-in-half-open-state: 3
  retry:
    instances:
      redis-memory-store:
        max-attempts: 3
        wait-duration: 1s
  bulkhead:
    instances:
      redis-memory-store:
        max-concurrent-calls: 20
        max-wait-duration: 5s
  timelimiter:
    instances:
      redis-memory-store:
        timeout-duration: 10s
```

## 降级策略

### 启用条件

- `smartcs.ai.memory.fallback.enabled=true` (默认启用)

### 降级触发

1. **Redis连接失败**
2. **Redis操作超时**
3. **Redis操作异常**
4. **熔断器打开状态**

### 降级行为

- **读取操作**：从内存存储获取数据
- **写入操作**：写入内存存储
- **删除操作**：同时清理Redis和内存存储

## 数据一致性

### 当前限制

由于 `ChatMemoryStore` 接口的限制，无法实现完整的数据同步机制：

1. **无法遍历所有会话**：接口不支持获取所有memoryId
2. **无法批量同步**：只能逐个会话同步
3. **数据可能丢失**：Redis故障期间的数据可能无法完全恢复

### 建议改进

1. **扩展接口**：为 ChatMemoryStore 添加遍历和批量操作接口
2. **事件机制**：使用Spring事件机制实现数据同步
3. **定时同步**：定期检查并同步数据

## 监控和健康检查

### 健康状态

- **Redis可用**：系统正常运行
- **Redis不可用但降级启用**：系统降级运行
- **Redis不可用且降级禁用**：系统不可用

### 监控指标

- Redis连接状态
- 降级触发次数
- 操作成功率
- 响应时间

## 使用建议

1. **生产环境**：建议启用降级机制
2. **开发环境**：可以禁用降级以简化调试
3. **监控告警**：设置Redis连接状态告警
4. **定期检查**：定期验证数据一致性

## 故障排查

### 常见问题

1. **Bean冲突**：确保只有一个主要的ChatMemoryStore实现
2. **配置错误**：检查Resilience4j配置是否正确
3. **降级不生效**：检查fallback.enabled配置
4. **数据不一致**：检查Redis连接状态和数据同步

### 调试方法

1. 查看日志中的降级相关信息
2. 使用 `isHealthy()` 方法检查系统状态
3. 使用 `testRedisConnection()` 方法测试Redis连接
4. 检查 `getStatus()` 方法返回的状态信息 