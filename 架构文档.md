电商客服子系统设计文档（含智能客服）

目录
	1.	架构总览
	2.	模块化设计
	3.	部署架构图（Mermaid）
	4.	ER 图（Mermaid）
	5.	表结构设计（MySQL 8.0）
	6.	设计要点与安全合规

⸻

1. 架构总览

客服子系统包括人工客服与智能客服（RAG + LLM）两大核心域，采用微服务 + 事件驱动模式，实现松耦合、可水平扩展。整体组件示意见下图。

⸻

2. 模块化设计

分层	微服务 / 模块	职责与说明
接入层	Gateway-Service	多渠道接入（H5/APP/小程序/微信客服），统一鉴权、限流、路由
会话域	Chat-Service	WebSocket 长连接管理、消息路由、离线推送
	Session-Service	会话生命周期管理（排队、转接、归档）
知识域	Knowledge-Service	FAQ 文档管理、分段向量生成、向量入库
	Bot-Service	RAG 检索 + Prompt 构建 + LLM 生成应答
工单域	Ticket-Service	自动工单、SLA 管控、客服指派、统计报表
公共域	User-Service	用户与客服基础信息、标签、权限管理
	File-Service	富媒体上传转存、文件 CDN 回源支持
基础设施	Redis、Kafka、MySQL、Elasticsearch、Milvus、Prometheus、Jaeger	支撑缓存、消息流、存储、检索、监控、追踪


⸻

2.4 会话域模块设计（详细）

2.4.1 目标与边界
	•	目标：提供低延迟、高并发、可弹性伸缩的实时聊天与会话管理能力，支持多渠道接入、排队分配、机器人/人工无缝切换，以及全量消息留存。
	•	边界：仅处理用户与客服/机器人之间的即时消息与会话状态，不负责知识检索或工单流程；下游依赖 Bot‑Service、Ticket‑Service。

2.4.2 组件拆分

组件	主要职责	技术选型
Chat-Service	WebSocket 连接网关：维护长连接、做消息编解码、心跳检测、灰度分流	Spring Boot + Netty (Reactor Netty)
Session-Service	会话生命周期：排队、分配、转接、结束；队列优先级 & SLA 监控	Spring Boot + Redis + Kafka
Presence-Service	在线状态 & 多端同步：同一用户多终端联动、掉线检测	Redis Stream + Key Expire Event
Message-Archiver	消息异步落库、分表写入、ES 索引同步	Kafka Consumer + MyBatis
Push-Service	离线/移动端推送：APNs/FCM/小程序订阅消息	Node/Go 微服务

2.4.3 核心时序图（建会话并发送消息）

sequenceDiagram
  participant Client
  participant Chat
  participant Session
  participant Redis
  participant Kafka
  participant DB
  Client->>Chat: WebSocket CONNECT & AUTH
  Chat->>Session: 创建/获取 session
  Session->>Redis: ZADD wait_queue (prio, userId)
  Session-->>Chat: 分配结果 (agentId / bot)
  Client->>Chat: sendMessage()
  Chat->>Kafka: Produce msg_event
  Kafka->>MessageArchiver: Consume & batch insert DB
  MessageArchiver->>DB: INSERT cs_message_x
  Chat-->>Client: ACK (msgId)

2.4.4 会话状态机

状态	事件	动作	下一状态
WAITING	agentAssigned	通知双方	ACTIVE
ACTIVE	userSilenceTimeout	发送提醒	WARNING
WARNING	timeoutExceeded	自动结束	CLOSED
ACTIVE	userEnd / agentEnd	保存总结	CLOSED

Spring StateMachine 持久化在 Redis，事件通过 Kafka Broadcast，保证多实例一致。

2.4.5 存储模型
	•	Redis：hash:session:{id} 保存实时会话上下文（agent、queuePos、lastMsgTs）。TTL=2h。
	•	MySQL：cs_session 记录历史；cs_message_* 分表存正文。
	•	Kafka Topic：chat.msg (生产) / chat.archive (消费)；分区键 session_id 保序。

2.4.6 性能与可用性
	•	水平扩展：Chat‑Service Pod × N，按用户 ID Hash sticky session；Session‑Service 读写 Redis + Kafka，天然分布式。
	•	削峰：客户端 → Chat‑Service 使用缓冲队列；消息写 Kafka，再批量落库减少 DB TPS 峰值。
	•	高可用：WebSocket 连接断线自动重连；Redis 主从 + Sentinel；Kafka 三副本；数据库主从 + ProxySQL。

2.4.7 安全与合规
	•	鉴权：JWT / OAuth2 Access‑Token 在握手时校验；内网 gRPC 使用 mTLS。
	•	敏感词过滤：Chat‑Service 调用内容安全 API；违规信息拒发且记录审计表。
	•	加密：TLS 1.3 传输；消息正文 AES‑256 at‑rest。

2.4.8 未来扩展
	•	多语种即时翻译（集成 GPT‑4o 翻译 model，实现跨境客服）。
	•	音视频客服：升级 WebRTC 通道 + STUN/TURN 集群。
	•	Agent Assist：实时摘要 + 推荐回复侧边栏，提高人工客服效率。

⸻

2.5 知识域模块设计（详细）

2.5.1 目标与边界
	•	目标：提供高效、准确、可扩展的知识问答能力，满足 80% 以上常见问题自动化解答，并为复杂场景提供上下文检索以辅助 LLM 生成答案。
	•	边界：专注电商业务知识（商品、订单、退换货、物流、促销等），不处理个人隐私信息；对接外部法律/支付/物流 API 由其他域负责。

2.5.2 组件拆分

组件	说明	技术选型
Knowledge-Service	FAQ/文档 CRUD、版本管理、段落切分、Embedding 任务编排	Spring Boot + Quartz/Artemis
Embedding-Worker	批量生成向量（REST 或队列消费），支持并行 / GPU	Python + FastAPI + PyTorch/BGE-Large
Vector-Store	存储 & 索引向量，支持 HNSW/IVF 索引	Milvus（分片副本）
Keyword-Search	关键字倒排索引，支持模糊查询	Elasticsearch
Bot-Service	RAG Pipeline，Top‑k 检索 + Prompt 组装 + LLM 调用	Spring Boot + LangChain4j 或自研
Cache	热门 FAQ 结果缓存，减少向量检索耗时	Redis (TTL 5‑30 min)

2.5.3 数据流 & 时序图

sequenceDiagram
  participant User
  participant Bot
  participant VectorDB
  participant MySQL
  participant LLM
  User->>Bot: 用户提问
  Bot->>VectorDB: 向量检索 Top‑k
  Bot->>MySQL: 拉取原始段落
  Bot->>LLM: 拼接 Prompt
  LLM-->>Bot: 生成应答
  Bot-->>User: 返回答案
  Bot-->>Redis: 热门问题缓存

2.5.4 数据存储 & 索引
	•	MySQL：存 cs_doc、cs_doc_embedding 元数据；支持事务、版本比对。
	•	Milvus：存 768/1536 维向量；启用 HNSW 索引（M=16, efConstruction=200），满足 QPS≈300，P99 < 120 ms。
	•	ES：存 FAQ 及标题摘要，支持前端实时搜索、运营后台检索。

2.5.5 向量化 & 模型策略

场景	模型	维度	说明
中文 FAQ	bge-large-zh	1024	中文语义效果佳
中英混合	e5‑large	1024	多语言检索
轻量端侧	MiniLM‑384	384	降低存储 & 延迟

动态选择：可根据问题语言检测自动选择不同模型生成向量，提升检索准确率。

2.5.6 更新策略
	1.	增量更新：文档变更触发 Embedding-Worker 任务，只处理修改段落。
	2.	全量重构：模型升级或字段变更触发；采用双写模式，新表/新 collection 验证后灰度切换。
	3.	版本控制：cs_doc.version_no + is_active 标记，确保线上与训练数据一致。

2.5.7 可用性与性能
	•	水平扩展：Milvus 分片，Embedding-Worker 多实例；支持 GPU 批量加速。
	•	缓存策略：Redis LRU + 二级缓存（本地 Caffeine）
	•	降级策略：向量库不可用时 fallback 到 ES 关键字搜索；LLM 超时返回 FAQ 快照。

2.5.8 安全与合规
	•	向量脱敏：Embedding 前对手机号/地址等敏感信息用占位符替换。
	•	权限控制：知识库管理 API 需 ROLE_KB_ADMIN；操作留审计日志。
	•	数据隔离：不同商家/品牌可通过 tenant_id 字段逻辑隔离向量集合（或物理集群）。

2.5.9 未来扩展
	•	主动学习：收集低置信度对话，人工标注后回流知识库。
	•	多模态：支持商品图片 → 图文向量检索（CLIP/VL模型）。
	•	Streaming RAG：流式 chunk + incremental generation，降低首 token 延迟。

⸻

3. 部署架构图

flowchart TD
  subgraph Edge/Gateway
    GW[API Gateway\nNginx / Spring Cloud Gateway]
  end
  subgraph Service
    CS[Chat‑Service]
    SS[Session‑Service]
    KS[Knowledge‑Service]
    BS[Bot‑Service]
    TS[Ticket‑Service]
    US[User‑Service]
    FS[File‑Service]
  end
  subgraph Infra
    R[Redis Cluster]
    K[Kafka Cluster]
    DB[(MySQL 主从)]
    ES[(Elasticsearch)]
    MV[(Milvus)]
  end

  U[用户 / 客服前端] -->|WebSocket / HTTPS| GW
  GW --> CS
  GW --> SS
  GW --> BS
  GW --> TS
  CS --> R
  CS --> K
  SS --> R
  SS --> DB
  KS --> ES & MV
  KS --> DB
  BS --> KS
  BS --> R
  BS --> K
  TS --> DB
  TS --> R
  FS --> DB
  FS --> R
  K --> DB
  subgraph Monitor
    PM[Prometheus] ---|metrics| CS & SS & BS & TS
    J[Jaeger] ---|trace| CS & SS & BS
  end


⸻

4. ER 图（核心实体关系）

erDiagram
  CS_USER ||--o{ CS_SESSION : "1:N"
  CS_SESSION ||--o{ CS_MESSAGE : "1:N"
  CS_SESSION ||--|{ CS_TICKET : "1:N"
  CS_TICKET ||--o{ CS_TICKET_COMMENT : "1:N"
  CS_USER ||--o{ CS_TICKET : "1:N"
  CS_DOC ||--o{ CS_DOC_EMBEDDING : "1:N"

  CS_Faq {
    bigint faq_id PK
    varchar question
    text answer_text
  }
  CS_DOC {
    bigint doc_id PK
    varchar title
    varchar oss_url
    int version_no
  }
  CS_DOC_EMBEDDING {
    bigint emb_id PK
    bigint doc_id FK
    int section_idx
    blob vector
  }
  CS_USER {
    bigint user_id PK
    varchar nick_name
    tinyint user_type
  }
  CS_SESSION {
    bigint session_id PK
    bigint customer_id FK
    bigint agent_id
    tinyint session_state
  }
  CS_MESSAGE {
    bigint msg_id PK
    bigint session_id FK
    bigint sender_id
    tinyint msg_type
  }
  CS_TICKET {
    bigint ticket_id PK
    bigint session_id FK
    bigint customer_id FK
    varchar category
    tinyint status
  }
  CS_TICKET_COMMENT {
    bigint comment_id PK
    bigint ticket_id FK
    bigint commenter_id
  }


⸻

5. 表结构设计（MySQL 8.0）
5.1 用户与客服
CREATE TABLE cs_user (
  user_id           BIGINT PRIMARY KEY,
  nick_name         VARCHAR(64) NOT NULL,
  avatar_url        VARCHAR(255),
  phone_mask        VARCHAR(32),
  user_type         TINYINT NOT NULL COMMENT '0=消费者 1=客服',
  status            TINYINT DEFAULT 1 COMMENT '1=正常 0=禁用',
  created_at        DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at        DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_type_status (user_type, status)
);
5.2 会话与消息
-- 会话表：一个用户与客服/机器人在同一窗口产生一条记录
CREATE TABLE cs_session (
  session_id        BIGINT PRIMARY KEY,
  customer_id       BIGINT NOT NULL,
  agent_id          BIGINT,
  session_state     TINYINT DEFAULT 0 COMMENT '0=排队 1=进行中 2=已结束',
  last_msg_time     DATETIME,
  created_at        DATETIME DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_customer_state (customer_id, session_state)
);

-- 消息表：存储文本/图片/卡片等，水平分表 & Kafka 落库
CREATE TABLE cs_message (
  msg_id            BIGINT PRIMARY KEY,
  session_id        BIGINT NOT NULL,
  sender_id         BIGINT NOT NULL,
  sender_role       TINYINT COMMENT '0=用户 1=客服 2=机器人',
  msg_type          TINYINT COMMENT '0=text 1=image 2=order_card ...',
  content           TEXT,                    -- JSON 存储富文本
  at_list           JSON,                    -- @xxx 列表
  created_at        DATETIME DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_session_time (session_id, created_at)
) PARTITION BY HASH(session_id) PARTITIONS 16;


5.3 FAQ 与知识库
-- FAQ 主表
CREATE TABLE cs_faq (
  faq_id            BIGINT PRIMARY KEY,
  question          VARCHAR(255) NOT NULL,
  answer_text       TEXT,
  hit_count         BIGINT DEFAULT 0,
  enabled           TINYINT DEFAULT 1,
  updated_at        DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FULLTEXT INDEX ft_question (question)
);

-- 文档上传记录
CREATE TABLE cs_doc (
  doc_id            BIGINT PRIMARY KEY,
  title             VARCHAR(255),
  oss_url           VARCHAR(512),
  file_type         VARCHAR(32),
  version_no        INT DEFAULT 1,
  created_by        BIGINT,
  created_at        DATETIME DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_title (title)
);

-- 文档段落向量
CREATE TABLE cs_doc_embedding (
  emb_id            BIGINT PRIMARY KEY,
  doc_id            BIGINT NOT NULL,
  section_idx       INT,
  content_snippet   TEXT,
  vector            BLOB,                   -- 1536 维向量，存储为 FLOAT4[]
  INDEX idx_doc_section (doc_id, section_idx)
);
复制编辑
采用 段落级 Embedding，检索命中后拼接上下文→Prompt→LLM • 向量落地 Milvus/Faiss 归档，MySQL 仅存元数据。
方案借鉴客服知识库设计要点。

5.4 工单系统
CREATE TABLE cs_ticket (
  ticket_id         BIGINT PRIMARY KEY,
  session_id        BIGINT,
  customer_id       BIGINT,
  category          VARCHAR(64) COMMENT 'refund/logistics/complaint/tech',
  title             VARCHAR(255),
  priority          TINYINT DEFAULT 3 COMMENT '1=紧急 2=高 3=中 4=低',
  status            TINYINT DEFAULT 0 COMMENT '0=新建 1=处理中 2=待客户 3=已解决 4=关闭',
  assignee_id       BIGINT,
  sla_minutes       INT DEFAULT 120,
  expired_at        DATETIME,
  created_at        DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at        DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_status_priority (status, priority),
  INDEX idx_customer (customer_id)
);

CREATE TABLE cs_ticket_comment (
  comment_id        BIGINT PRIMARY KEY,
  ticket_id         BIGINT NOT NULL,
  commenter_id      BIGINT,
  content           TEXT,
  created_at        DATETIME DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_ticket_time (ticket_id, created_at)
);

⸻

6. 设计要点与安全合规

类别	措施
一致性	Kafka + 本地事务表，确保消息与落库一致；使用 Snowflake ID 保证全局唯一性
性能优化	WebSocket 长连接、Redis 缓存、ES 索引、Milvus 向量索引、Sentinel 限流、Resilience4j 熔断
监控可观测	Prometheus 指标监控、Grafana 可视化、Jaeger 链路追踪、SLA 统计分析
安全合规	用户数据脱敏、敏感字段加密（手机号、地址）、JWT 接口鉴权、RBAC 权限控制、数据留存满足《网络安全法》


⸻

文档完。