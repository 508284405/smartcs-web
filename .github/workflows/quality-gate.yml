name: RAG Quality Gate

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  JAVA_VERSION: '17'
  NODE_VERSION: '18'
  EVAL_SERVICE_URL: ${{ vars.EVAL_SERVICE_URL || 'http://localhost:8088' }}

jobs:
  # æ„å»ºå’Œæµ‹è¯•é˜¶æ®µ
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        
    - name: Cache Maven dependencies
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
        restore-keys: |
          ${{ runner.os }}-maven-
          
    - name: Build with Maven
      run: mvn clean compile -DskipTests
      
    - name: Run unit tests
      run: mvn test
      
    - name: Generate test reports
      run: mvn surefire-report:report
      
    - name: Upload test results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: test-results
        path: target/surefire-reports/
        
  # RAGè¯„ä¼°è´¨é‡é—¸é—¨
  rag-quality-gate:
    name: RAG Quality Gate
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.event_name == 'pull_request' || contains(github.ref, 'main')
    
    services:
      # å¯åŠ¨è¯„ä¼°æœåŠ¡
      ragas-eval:
        image: ragas-eval-service:latest
        ports:
          - 8088:8088
        env:
          MYSQL_HOST: mysql
          MYSQL_USER: ragas_user
          MYSQL_PASSWORD: ${{ secrets.MYSQL_PASSWORD }}
          KAFKA_SERVERS: kafka:9092
        options: >-
          --health-cmd "curl -f http://localhost:8088/health"
          --health-interval 30s
          --health-timeout 10s
          --health-retries 5
          
      # MySQLæ•°æ®åº“
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: ${{ secrets.MYSQL_ROOT_PASSWORD }}
          MYSQL_DATABASE: ragas_eval
          MYSQL_USER: ragas_user
          MYSQL_PASSWORD: ${{ secrets.MYSQL_PASSWORD }}
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
          
      # Kafka
      kafka:
        image: confluentinc/cp-kafka:latest
        env:
          KAFKA_BROKER_ID: 1
          KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
          KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
          KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
          
      # Zookeeper
      zookeeper:
        image: confluentinc/cp-zookeeper:latest
        env:
          ZOOKEEPER_CLIENT_PORT: 2181
          ZOOKEEPER_TICK_TIME: 2000
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Wait for services to be ready
      run: |
        echo "ç­‰å¾…æœåŠ¡å¯åŠ¨..."
        sleep 30
        
        # æ£€æŸ¥è¯„ä¼°æœåŠ¡å¥åº·çŠ¶æ€
        for i in {1..10}; do
          if curl -f http://localhost:8088/health; then
            echo "è¯„ä¼°æœåŠ¡å·²å°±ç»ª"
            break
          fi
          echo "ç­‰å¾…è¯„ä¼°æœåŠ¡å¯åŠ¨... ($i/10)"
          sleep 10
        done
        
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y jq bc curl
        
    - name: Make scripts executable
      run: chmod +x scripts/baseline-eval.sh
      
    - name: Run RAG baseline evaluation
      id: baseline_eval
      env:
        EVAL_SERVICE_URL: http://localhost:8088
        BASELINE_FILE: scripts/baseline-dataset.json
        OUTPUT_FILE: target/baseline-eval-result.json
        CONFIG_FILE: scripts/eval-thresholds.yaml
      run: |
        echo "å¼€å§‹RAGåŸºå‡†é›†è¯„ä¼°..."
        
        # åˆ›å»ºç›®æ ‡ç›®å½•
        mkdir -p target
        
        # æ‰§è¡Œè¯„ä¼°è„šæœ¬
        if ./scripts/baseline-eval.sh; then
          echo "quality_gate_passed=true" >> $GITHUB_OUTPUT
          echo "è¯„ä¼°é€šè¿‡è´¨é‡é—¸é—¨"
        else
          echo "quality_gate_passed=false" >> $GITHUB_OUTPUT
          echo "è¯„ä¼°æœªé€šè¿‡è´¨é‡é—¸é—¨"
          exit 1
        fi
        
    - name: Parse evaluation results
      if: always()
      run: |
        if [ -f target/baseline-eval-result.json ]; then
          echo "=== è¯„ä¼°ç»“æœæ‘˜è¦ ==="
          
          total_items=$(jq -r '.aggregate.total_items // 0' target/baseline-eval-result.json)
          pass_threshold=$(jq -r '.aggregate.pass_threshold // false' target/baseline-eval-result.json)
          
          avg_faithfulness=$(jq -r '.aggregate.avg_faithfulness // 0' target/baseline-eval-result.json)
          avg_answer_relevancy=$(jq -r '.aggregate.avg_answer_relevancy // 0' target/baseline-eval-result.json)
          avg_context_precision=$(jq -r '.aggregate.avg_context_precision // 0' target/baseline-eval-result.json)
          avg_context_recall=$(jq -r '.aggregate.avg_context_recall // 0' target/baseline-eval-result.json)
          
          echo "æ€»è¯„ä¼°é¡¹æ•°: $total_items"
          echo "æ•´ä½“é€šè¿‡çŠ¶æ€: $pass_threshold"
          echo "å¹³å‡å¿ å®åº¦: $avg_faithfulness"
          echo "å¹³å‡ç­”æ¡ˆç›¸å…³æ€§: $avg_answer_relevancy"
          echo "å¹³å‡ä¸Šä¸‹æ–‡ç²¾ç¡®åº¦: $avg_context_precision"
          echo "å¹³å‡ä¸Šä¸‹æ–‡å¬å›åº¦: $avg_context_recall"
          
          # è®¾ç½®è¾“å‡ºå˜é‡ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "total_items=$total_items" >> $GITHUB_ENV
          echo "pass_threshold=$pass_threshold" >> $GITHUB_ENV
          echo "avg_faithfulness=$avg_faithfulness" >> $GITHUB_ENV
          echo "avg_answer_relevancy=$avg_answer_relevancy" >> $GITHUB_ENV
        else
          echo "è¯„ä¼°ç»“æœæ–‡ä»¶ä¸å­˜åœ¨"
        fi
        
    - name: Upload evaluation results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: rag-evaluation-results
        path: |
          target/baseline-eval-result.json
          target/baseline-eval-*.log
        retention-days: 30
        
    - name: Generate evaluation report
      if: always()
      run: |
        # ç”ŸæˆHTMLæŠ¥å‘Š
        cat > target/evaluation-report.html << EOF
        <!DOCTYPE html>
        <html>
        <head>
            <title>RAGè¯„ä¼°æŠ¥å‘Š</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; }
                .header { background-color: #f0f0f0; padding: 10px; border-radius: 5px; }
                .metrics { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin: 20px 0; }
                .metric-card { border: 1px solid #ddd; padding: 15px; border-radius: 5px; }
                .success { background-color: #d4edda; border-color: #c3e6cb; }
                .failure { background-color: #f8d7da; border-color: #f5c6cb; }
                .metric-value { font-size: 2em; font-weight: bold; }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>RAGç³»ç»Ÿè¯„ä¼°æŠ¥å‘Š</h1>
                <p>æ„å»º: ${{ github.run_number }} | åˆ†æ”¯: ${{ github.ref_name }} | æäº¤: ${{ github.sha }}</p>
                <p>æ—¶é—´: $(date)</p>
            </div>
            
            <div class="summary $(if [ "$pass_threshold" = "true" ]; then echo "success"; else echo "failure"; fi)">
                <h2>æ€»ä½“ç»“æœ</h2>
                <p>è¯„ä¼°é¡¹ç›®æ•°: ${total_items:-0}</p>
                <p>è´¨é‡é—¸é—¨: $(if [ "$pass_threshold" = "true" ]; then echo "âœ… é€šè¿‡"; else echo "âŒ å¤±è´¥"; fi)</p>
            </div>
            
            <div class="metrics">
                <div class="metric-card">
                    <h3>å¿ å®åº¦ (Faithfulness)</h3>
                    <div class="metric-value">${avg_faithfulness:-0.000}</div>
                    <p>é˜ˆå€¼: â‰¥ 0.85</p>
                </div>
                
                <div class="metric-card">
                    <h3>ç­”æ¡ˆç›¸å…³æ€§ (Answer Relevancy)</h3>
                    <div class="metric-value">${avg_answer_relevancy:-0.000}</div>
                    <p>é˜ˆå€¼: â‰¥ 0.80</p>
                </div>
                
                <div class="metric-card">
                    <h3>ä¸Šä¸‹æ–‡ç²¾ç¡®åº¦ (Context Precision)</h3>
                    <div class="metric-value">${avg_context_precision:-0.000}</div>
                    <p>é˜ˆå€¼: â‰¥ 0.70</p>
                </div>
                
                <div class="metric-card">
                    <h3>ä¸Šä¸‹æ–‡å¬å›åº¦ (Context Recall)</h3>
                    <div class="metric-value">${avg_context_recall:-0.000}</div>
                    <p>é˜ˆå€¼: â‰¥ 0.75</p>
                </div>
            </div>
            
            <div class="details">
                <h2>è¯¦ç»†ç»“æœ</h2>
                <pre id="raw-results"></pre>
            </div>
            
            <script>
                // å¦‚æœæœ‰åŸå§‹JSONç»“æœï¼Œæ˜¾ç¤ºåœ¨é¡µé¢ä¸Š
                fetch('./baseline-eval-result.json')
                    .then(response => response.json())
                    .then(data => {
                        document.getElementById('raw-results').textContent = JSON.stringify(data, null, 2);
                    })
                    .catch(() => {
                        document.getElementById('raw-results').textContent = 'åŸå§‹ç»“æœæ–‡ä»¶ä¸å¯ç”¨';
                    });
            </script>
        </body>
        </html>
        EOF
        
    - name: Upload evaluation report
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: rag-evaluation-report
        path: target/evaluation-report.html
        
    - name: Comment on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          
          let comment = `## ğŸ¤– RAGè´¨é‡é—¸é—¨æŠ¥å‘Š\n\n`;
          
          if (process.env.pass_threshold === 'true') {
            comment += `âœ… **è´¨é‡é—¸é—¨é€šè¿‡**\n\n`;
          } else {
            comment += `âŒ **è´¨é‡é—¸é—¨å¤±è´¥**\n\n`;
          }
          
          comment += `### ğŸ“Š è¯„ä¼°æŒ‡æ ‡\n\n`;
          comment += `| æŒ‡æ ‡ | å€¼ | é˜ˆå€¼ | çŠ¶æ€ |\n`;
          comment += `|------|----|----- |------|\n`;
          
          const faithfulness = parseFloat(process.env.avg_faithfulness || 0);
          const relevancy = parseFloat(process.env.avg_answer_relevancy || 0);
          const precision = parseFloat(process.env.avg_context_precision || 0);
          const recall = parseFloat(process.env.avg_context_recall || 0);
          
          comment += `| å¿ å®åº¦ | ${faithfulness.toFixed(3)} | â‰¥ 0.85 | ${faithfulness >= 0.85 ? 'âœ…' : 'âŒ'} |\n`;
          comment += `| ç­”æ¡ˆç›¸å…³æ€§ | ${relevancy.toFixed(3)} | â‰¥ 0.80 | ${relevancy >= 0.80 ? 'âœ…' : 'âŒ'} |\n`;
          comment += `| ä¸Šä¸‹æ–‡ç²¾ç¡®åº¦ | ${precision.toFixed(3)} | â‰¥ 0.70 | ${precision >= 0.70 ? 'âœ…' : 'âŒ'} |\n`;
          comment += `| ä¸Šä¸‹æ–‡å¬å›åº¦ | ${recall.toFixed(3)} | â‰¥ 0.75 | ${recall >= 0.75 ? 'âœ…' : 'âŒ'} |\n`;
          
          comment += `\n### ğŸ“ˆ æ€»ä½“ç»Ÿè®¡\n\n`;
          comment += `- **è¯„ä¼°é¡¹ç›®æ•°**: ${process.env.total_items || 0}\n`;
          comment += `- **æ„å»ºç¼–å·**: ${{ github.run_number }}\n`;
          comment += `- **æäº¤å“ˆå¸Œ**: \`${{ github.sha }}\`\n`;
          
          if (process.env.pass_threshold !== 'true') {
            comment += `\n### âš ï¸ æ”¹è¿›å»ºè®®\n\n`;
            comment += `è´¨é‡é—¸é—¨æœªé€šè¿‡ï¼Œå»ºè®®ï¼š\n`;
            comment += `1. æ£€æŸ¥RAGç³»ç»Ÿé…ç½®å’Œç®—æ³•\n`;
            comment += `2. åˆ†æè¯„ä¼°ç»“æœæ‰¾å‡ºé—®é¢˜æ ¹å› \n`;
            comment += `3. ä¼˜åŒ–æ£€ç´¢å’Œç”Ÿæˆç­–ç•¥\n`;
            comment += `4. è€ƒè™‘æ›´æ–°åŸºå‡†æ•°æ®é›†\n`;
          }
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
          
    - name: Fail if quality gate failed
      if: steps.baseline_eval.outputs.quality_gate_passed == 'false'
      run: |
        echo "âŒ RAGè´¨é‡é—¸é—¨å¤±è´¥ï¼Œé˜»æ–­æµæ°´çº¿"
        exit 1