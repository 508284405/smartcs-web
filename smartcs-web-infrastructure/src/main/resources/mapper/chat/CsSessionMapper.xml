<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.leyue.smartcs.chat.mapper.CsSessionMapper">
    
    <!-- 根据会话ID查询会话 -->
    <select id="selectBySessionId" resultType="com.leyue.smartcs.chat.dataobject.CsSessionDO">
        SELECT * FROM t_cs_session WHERE session_id = #{sessionId} AND is_deleted = 0
    </select>
    
    <!-- 根据客户ID查询活跃会话 -->
    <select id="findActiveSessionByCustomerId" resultType="com.leyue.smartcs.chat.dataobject.CsSessionDO">
        SELECT * FROM t_cs_session WHERE customer_id = #{customerId} AND session_state = 1 AND is_deleted = 0 LIMIT 1
    </select>
    
    <!-- 查询客户最新一条处理中的会话（排队或进行中） -->
    <select id="findCustomerActiveSession" resultType="com.leyue.smartcs.chat.dataobject.CsSessionDO">
        SELECT * FROM t_cs_session WHERE customer_id = #{customerId} AND session_state IN (0, 1) AND is_deleted = 0 ORDER BY created_at DESC LIMIT 1
    </select>
    
    <!-- 根据客户ID查询历史会话（按创建时间倒序） -->
    <select id="findSessionsByCustomerId" resultType="com.leyue.smartcs.chat.dataobject.CsSessionDO">
        SELECT * FROM t_cs_session WHERE customer_id = #{customerId} AND is_deleted = 0 ORDER BY created_at DESC LIMIT #{limit}
    </select>
    
    <!-- 根据客服ID查询活跃会话列表 -->
    <select id="findActiveSessionsByAgentId" resultType="com.leyue.smartcs.chat.dataobject.CsSessionDO">
        SELECT * FROM t_cs_session WHERE agent_id = #{agentId} AND session_state = 1 AND is_deleted = 0
    </select>
    
    <!-- 根据状态查询会话列表（按创建时间排序） -->
    <select id="findSessionsByStatus" resultType="com.leyue.smartcs.chat.dataobject.CsSessionDO">
        SELECT * FROM t_cs_session WHERE status = #{status} AND is_deleted = 0 ORDER BY create_time ASC LIMIT #{limit} OFFSET #{offset}
    </select>
</mapper> 