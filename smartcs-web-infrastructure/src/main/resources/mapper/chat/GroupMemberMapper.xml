<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.leyue.smartcs.chat.mapper.GroupMemberMapper">
    
    <!-- 获取群成员列表 -->
    <select id="findByGroupId" resultType="com.leyue.smartcs.chat.dataobject.GroupMemberDO">
        SELECT * FROM t_im_group_member 
        WHERE group_id = #{groupId} 
        AND is_deleted = 0
        ORDER BY joined_at ASC
    </select>
    
    <!-- 获取群成员ID列表 -->
    <select id="findMemberIdsByGroupId" resultType="java.lang.Long">
        SELECT user_id FROM t_im_group_member 
        WHERE group_id = #{groupId} 
        AND is_deleted = 0
    </select>
    
    <!-- 检查用户是否为群成员 -->
    <select id="findByGroupIdAndUserId" resultType="com.leyue.smartcs.chat.dataobject.GroupMemberDO">
        SELECT * FROM t_im_group_member 
        WHERE group_id = #{groupId} 
        AND user_id = #{userId}
    </select>
    
    <!-- 更新群成员角色 -->
    <update id="updateMemberRole">
        UPDATE t_im_group_member 
        SET role = #{role}
        WHERE group_id = #{groupId} 
        AND user_id = #{userId}
        AND is_deleted = 0
    </update>
    
    <!-- 移除群成员（软删除） -->
    <update id="removeMember">
        UPDATE t_im_group_member 
        SET is_deleted = 1
        WHERE group_id = #{groupId} 
        AND user_id = #{userId}
        AND is_deleted = 0
    </update>
    
    <!-- 获取群成员数量 -->
    <select id="countByGroupId" resultType="int">
        SELECT COUNT(*) FROM t_im_group_member 
        WHERE group_id = #{groupId} 
        AND is_deleted = 0
    </select>
    
    <!-- 批量添加群成员 -->
    <insert id="batchInsert" parameterType="java.util.List">
        INSERT INTO t_im_group_member (
            group_id, user_id, role, joined_at, is_deleted
        ) VALUES
        <foreach collection="list" item="item" separator=",">
            (
                #{item.groupId}, #{item.userId}, #{item.role}, 
                #{item.joinedAt}, #{item.isDeleted}
            )
        </foreach>
    </insert>
    
</mapper>