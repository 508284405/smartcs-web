<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.leyue.smartcs.eval.mapper.RagEvalRetrievalDetailMapper">

    <!-- RAG评估检索详情结果映射 -->
    <resultMap id="BaseResultMap" type="com.leyue.smartcs.eval.dataobject.RagEvalRetrievalDetailDO">
        <id column="id" jdbcType="BIGINT" property="id"/>
        <result column="run_id" jdbcType="VARCHAR" property="runId"/>
        <result column="case_id" jdbcType="VARCHAR" property="caseId"/>
        <result column="query_original" jdbcType="LONGVARCHAR" property="queryOriginal"/>
        <result column="query_rewritten" jdbcType="LONGVARCHAR" property="queryRewritten"/>
        <result column="query_embedding_time_ms" jdbcType="INTEGER" property="queryEmbeddingTimeMs"/>
        
        <!-- 检索阶段结果 -->
        <result column="retrieval_candidates" jdbcType="LONGVARCHAR" property="retrievalCandidates" typeHandler="com.baomidou.mybatisplus.extension.handlers.JacksonTypeHandler"/>
        <result column="retrieval_scores" jdbcType="LONGVARCHAR" property="retrievalScores" typeHandler="com.baomidou.mybatisplus.extension.handlers.JacksonTypeHandler"/>
        <result column="retrieval_latency_ms" jdbcType="INTEGER" property="retrievalLatencyMs"/>
        <result column="retrieval_model_used" jdbcType="VARCHAR" property="retrievalModelUsed"/>
        <result column="retrieval_params" jdbcType="LONGVARCHAR" property="retrievalParams" typeHandler="com.baomidou.mybatisplus.extension.handlers.JacksonTypeHandler"/>
        
        <!-- 重排序阶段结果 -->
        <result column="rerank_candidates" jdbcType="LONGVARCHAR" property="rerankCandidates" typeHandler="com.baomidou.mybatisplus.extension.handlers.JacksonTypeHandler"/>
        <result column="rerank_scores" jdbcType="LONGVARCHAR" property="rerankScores" typeHandler="com.baomidou.mybatisplus.extension.handlers.JacksonTypeHandler"/>
        <result column="rerank_latency_ms" jdbcType="INTEGER" property="rerankLatencyMs"/>
        <result column="rerank_model_used" jdbcType="VARCHAR" property="rerankModelUsed"/>
        <result column="rerank_params" jdbcType="LONGVARCHAR" property="rerankParams" typeHandler="com.baomidou.mybatisplus.extension.handlers.JacksonTypeHandler"/>
        <result column="rerank_improvement" jdbcType="DECIMAL" property="rerankImprovement"/>
        
        <!-- 过滤和处理 -->
        <result column="final_contexts" jdbcType="LONGVARCHAR" property="finalContexts" typeHandler="com.baomidou.mybatisplus.extension.handlers.JacksonTypeHandler"/>
        <result column="filtered_candidates" jdbcType="LONGVARCHAR" property="filteredCandidates" typeHandler="com.baomidou.mybatisplus.extension.handlers.JacksonTypeHandler"/>
        <result column="context_compression_ratio" jdbcType="DECIMAL" property="contextCompressionRatio"/>
        
        <!-- 评估指标 -->
        <result column="precision_at_1" jdbcType="DECIMAL" property="precisionAt1"/>
        <result column="precision_at_3" jdbcType="DECIMAL" property="precisionAt3"/>
        <result column="precision_at_5" jdbcType="DECIMAL" property="precisionAt5"/>
        <result column="recall_at_1" jdbcType="DECIMAL" property="recallAt1"/>
        <result column="recall_at_3" jdbcType="DECIMAL" property="recallAt3"/>
        <result column="recall_at_5" jdbcType="DECIMAL" property="recallAt5"/>
        <result column="mrr_score" jdbcType="DECIMAL" property="mrrScore"/>
        <result column="ndcg_at_3" jdbcType="DECIMAL" property="ndcgAt3"/>
        <result column="ndcg_at_5" jdbcType="DECIMAL" property="ndcgAt5"/>
        
        <!-- RAGAS指标 -->
        <result column="context_precision_score" jdbcType="DECIMAL" property="contextPrecisionScore"/>
        <result column="context_recall_score" jdbcType="DECIMAL" property="contextRecallScore"/>
        
        <!-- 错误信息 -->
        <result column="error_stage" jdbcType="VARCHAR" property="errorStage"/>
        <result column="error_message" jdbcType="LONGVARCHAR" property="errorMessage"/>
        
        <result column="metadata" jdbcType="LONGVARCHAR" property="metadata" typeHandler="com.baomidou.mybatisplus.extension.handlers.JacksonTypeHandler"/>
        <result column="created_at" jdbcType="BIGINT" property="createdAt"/>
        <result column="updated_at" jdbcType="BIGINT" property="updatedAt"/>
    </resultMap>

    <!-- 根据运行ID查询检索详情列表 -->
    <select id="selectByRunId" parameterType="java.lang.String" resultMap="BaseResultMap">
        SELECT * FROM t_rag_eval_retrieval_detail 
        WHERE run_id = #{runId} 
        ORDER BY created_at ASC
    </select>

    <!-- 根据运行ID和用例ID查询检索详情 -->
    <select id="selectByRunIdAndCaseId" resultMap="BaseResultMap">
        SELECT * FROM t_rag_eval_retrieval_detail 
        WHERE run_id = #{runId} 
        AND case_id = #{caseId}
    </select>

    <!-- 根据用例ID查询检索详情列表 -->
    <select id="selectByCaseId" parameterType="java.lang.String" resultMap="BaseResultMap">
        SELECT * FROM t_rag_eval_retrieval_detail 
        WHERE case_id = #{caseId} 
        ORDER BY created_at DESC
    </select>

    <!-- 查询有错误的检索详情 -->
    <select id="selectWithErrors" parameterType="java.lang.String" resultMap="BaseResultMap">
        SELECT * FROM t_rag_eval_retrieval_detail 
        WHERE run_id = #{runId} 
        AND error_message IS NOT NULL 
        ORDER BY created_at ASC
    </select>

    <!-- 查询成功的检索详情 -->
    <select id="selectSuccessful" parameterType="java.lang.String" resultMap="BaseResultMap">
        SELECT * FROM t_rag_eval_retrieval_detail 
        WHERE run_id = #{runId} 
        AND error_message IS NULL 
        ORDER BY created_at ASC
    </select>

    <!-- 统计运行的检索详情数量 -->
    <select id="countByRunId" parameterType="java.lang.String" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM t_rag_eval_retrieval_detail 
        WHERE run_id = #{runId}
    </select>

    <!-- 统计运行的成功检索详情数量 -->
    <select id="countSuccessfulByRunId" parameterType="java.lang.String" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM t_rag_eval_retrieval_detail 
        WHERE run_id = #{runId} 
        AND error_message IS NULL
    </select>

    <!-- 统计运行的失败检索详情数量 -->
    <select id="countFailedByRunId" parameterType="java.lang.String" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM t_rag_eval_retrieval_detail 
        WHERE run_id = #{runId} 
        AND error_message IS NOT NULL
    </select>

    <!-- 查询检索延迟统计 -->
    <select id="selectLatencyStats" parameterType="java.lang.String" resultType="java.util.Map">
        SELECT 
            AVG(retrieval_latency_ms) as avg_retrieval_latency,
            MIN(retrieval_latency_ms) as min_retrieval_latency,
            MAX(retrieval_latency_ms) as max_retrieval_latency,
            AVG(rerank_latency_ms) as avg_rerank_latency,
            MIN(rerank_latency_ms) as min_rerank_latency,
            MAX(rerank_latency_ms) as max_rerank_latency,
            AVG(query_embedding_time_ms) as avg_embedding_time
        FROM t_rag_eval_retrieval_detail 
        WHERE run_id = #{runId} 
        AND error_message IS NULL
    </select>

    <!-- 查询检索指标统计 -->
    <select id="selectRetrievalMetricsStats" parameterType="java.lang.String" resultType="java.util.Map">
        SELECT 
            AVG(precision_at_1) as avg_precision_at_1,
            AVG(precision_at_3) as avg_precision_at_3,
            AVG(precision_at_5) as avg_precision_at_5,
            AVG(recall_at_1) as avg_recall_at_1,
            AVG(recall_at_3) as avg_recall_at_3,
            AVG(recall_at_5) as avg_recall_at_5,
            AVG(mrr_score) as avg_mrr,
            AVG(ndcg_at_3) as avg_ndcg_at_3,
            AVG(ndcg_at_5) as avg_ndcg_at_5,
            AVG(context_precision_score) as avg_context_precision,
            AVG(context_recall_score) as avg_context_recall
        FROM t_rag_eval_retrieval_detail 
        WHERE run_id = #{runId} 
        AND error_message IS NULL
    </select>

    <!-- 删除运行的所有检索详情 -->
    <delete id="deleteByRunId" parameterType="java.lang.String">
        DELETE FROM t_rag_eval_retrieval_detail WHERE run_id = #{runId}
    </delete>

    <!-- 根据运行ID列表批量删除检索详情 -->
    <delete id="deleteByRunIds">
        DELETE FROM t_rag_eval_retrieval_detail 
        WHERE run_id IN
        <foreach collection="runIds" item="runId" open="(" separator="," close=")">
            #{runId}
        </foreach>
    </delete>

</mapper>