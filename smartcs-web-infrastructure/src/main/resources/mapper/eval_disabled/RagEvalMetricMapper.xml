<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.leyue.smartcs.eval.mapper.RagEvalMetricMapper">

    <!-- RAG评估指标结果映射 -->
    <resultMap id="BaseResultMap" type="com.leyue.smartcs.eval.dataobject.RagEvalMetricDO">
        <id column="id" jdbcType="BIGINT" property="id"/>
        <result column="run_id" jdbcType="VARCHAR" property="runId"/>
        <result column="metric_category" jdbcType="VARCHAR" property="metricCategory"/>
        
        <!-- 检索指标 -->
        <result column="precision_at_1" jdbcType="DECIMAL" property="precisionAt1"/>
        <result column="precision_at_3" jdbcType="DECIMAL" property="precisionAt3"/>
        <result column="precision_at_5" jdbcType="DECIMAL" property="precisionAt5"/>
        <result column="recall_at_1" jdbcType="DECIMAL" property="recallAt1"/>
        <result column="recall_at_3" jdbcType="DECIMAL" property="recallAt3"/>
        <result column="recall_at_5" jdbcType="DECIMAL" property="recallAt5"/>
        <result column="mrr" jdbcType="DECIMAL" property="mrr"/>
        <result column="ndcg_at_3" jdbcType="DECIMAL" property="ndcgAt3"/>
        <result column="ndcg_at_5" jdbcType="DECIMAL" property="ndcgAt5"/>
        <result column="context_precision" jdbcType="DECIMAL" property="contextPrecision"/>
        <result column="context_recall" jdbcType="DECIMAL" property="contextRecall"/>
        <result column="rerank_improvement" jdbcType="DECIMAL" property="rerankImprovement"/>
        
        <!-- 生成指标 -->
        <result column="faithfulness" jdbcType="DECIMAL" property="faithfulness"/>
        <result column="answer_relevancy" jdbcType="DECIMAL" property="answerRelevancy"/>
        <result column="citation_consistency" jdbcType="DECIMAL" property="citationConsistency"/>
        <result column="completeness" jdbcType="DECIMAL" property="completeness"/>
        <result column="conciseness" jdbcType="DECIMAL" property="conciseness"/>
        <result column="groundedness" jdbcType="DECIMAL" property="groundedness"/>
        <result column="factual_correctness" jdbcType="DECIMAL" property="factualCorrectness"/>
        
        <!-- 效率指标 -->
        <result column="avg_retrieval_latency_ms" jdbcType="DECIMAL" property="avgRetrievalLatencyMs"/>
        <result column="avg_rerank_latency_ms" jdbcType="DECIMAL" property="avgRerankLatencyMs"/>
        <result column="avg_generation_latency_ms" jdbcType="DECIMAL" property="avgGenerationLatencyMs"/>
        <result column="avg_e2e_latency_ms" jdbcType="DECIMAL" property="avgE2eLatencyMs"/>
        <result column="avg_input_tokens" jdbcType="DECIMAL" property="avgInputTokens"/>
        <result column="avg_output_tokens" jdbcType="DECIMAL" property="avgOutputTokens"/>
        <result column="avg_cost_usd" jdbcType="DECIMAL" property="avgCostUsd"/>
        
        <!-- 鲁棒性指标 -->
        <result column="robustness_score" jdbcType="DECIMAL" property="robustnessScore"/>
        <result column="variance_threshold" jdbcType="DECIMAL" property="varianceThreshold"/>
        <result column="perturbation_consistency" jdbcType="DECIMAL" property="perturbationConsistency"/>
        
        <!-- 聚合统计 -->
        <result column="sample_count" jdbcType="INTEGER" property="sampleCount"/>
        <result column="success_rate" jdbcType="DECIMAL" property="successRate"/>
        <result column="error_rate" jdbcType="DECIMAL" property="errorRate"/>
        
        <!-- JSON字段 -->
        <result column="detailed_metrics" jdbcType="LONGVARCHAR" property="detailedMetrics" typeHandler="com.baomidou.mybatisplus.extension.handlers.JacksonTypeHandler"/>
        <result column="confidence_intervals" jdbcType="LONGVARCHAR" property="confidenceIntervals" typeHandler="com.baomidou.mybatisplus.extension.handlers.JacksonTypeHandler"/>
        <result column="statistical_tests" jdbcType="LONGVARCHAR" property="statisticalTests" typeHandler="com.baomidou.mybatisplus.extension.handlers.JacksonTypeHandler"/>
        
        <result column="metadata" jdbcType="LONGVARCHAR" property="metadata" typeHandler="com.baomidou.mybatisplus.extension.handlers.JacksonTypeHandler"/>
        <result column="created_at" jdbcType="BIGINT" property="createdAt"/>
        <result column="updated_at" jdbcType="BIGINT" property="updatedAt"/>
    </resultMap>

    <!-- 根据运行ID查询指标列表 -->
    <select id="selectByRunId" parameterType="java.lang.String" resultMap="BaseResultMap">
        SELECT * FROM t_rag_eval_metric 
        WHERE run_id = #{runId} 
        ORDER BY metric_category
    </select>

    <!-- 根据运行ID和指标类别查询指标 -->
    <select id="selectByRunIdAndCategory" resultMap="BaseResultMap">
        SELECT * FROM t_rag_eval_metric 
        WHERE run_id = #{runId} 
        AND metric_category = #{category}
    </select>

    <!-- 根据指标类别查询指标列表 -->
    <select id="selectByCategory" parameterType="java.lang.String" resultMap="BaseResultMap">
        SELECT * FROM t_rag_eval_metric 
        WHERE metric_category = #{category} 
        ORDER BY created_at DESC
    </select>

    <!-- 根据时间范围查询指标列表 -->
    <select id="selectByTimeRange" resultMap="BaseResultMap">
        SELECT * FROM t_rag_eval_metric 
        WHERE created_at &gt;= #{startTime} 
        AND created_at &lt;= #{endTime}
        ORDER BY created_at DESC
    </select>

    <!-- 根据运行ID列表查询指标列表 -->
    <select id="selectByRunIds" resultMap="BaseResultMap">
        SELECT * FROM t_rag_eval_metric 
        WHERE run_id IN
        <foreach collection="runIds" item="runId" open="(" separator="," close=")">
            #{runId}
        </foreach>
        ORDER BY run_id, metric_category
    </select>

    <!-- 查询检索类指标统计 -->
    <select id="selectRetrievalMetricsStats" resultType="java.util.Map">
        SELECT 
            AVG(precision_at_1) as avg_precision_at_1,
            AVG(precision_at_3) as avg_precision_at_3,
            AVG(precision_at_5) as avg_precision_at_5,
            AVG(recall_at_1) as avg_recall_at_1,
            AVG(recall_at_3) as avg_recall_at_3,
            AVG(recall_at_5) as avg_recall_at_5,
            AVG(mrr) as avg_mrr,
            AVG(context_precision) as avg_context_precision,
            AVG(context_recall) as avg_context_recall
        FROM t_rag_eval_metric 
        WHERE metric_category = 'retrieval'
        AND run_id IN
        <foreach collection="runIds" item="runId" open="(" separator="," close=")">
            #{runId}
        </foreach>
    </select>

    <!-- 查询生成类指标统计 -->
    <select id="selectGenerationMetricsStats" resultType="java.util.Map">
        SELECT 
            AVG(faithfulness) as avg_faithfulness,
            AVG(answer_relevancy) as avg_answer_relevancy,
            AVG(citation_consistency) as avg_citation_consistency,
            AVG(completeness) as avg_completeness,
            AVG(conciseness) as avg_conciseness,
            AVG(groundedness) as avg_groundedness,
            AVG(factual_correctness) as avg_factual_correctness
        FROM t_rag_eval_metric 
        WHERE metric_category = 'generation'
        AND run_id IN
        <foreach collection="runIds" item="runId" open="(" separator="," close=")">
            #{runId}
        </foreach>
    </select>

    <!-- 查询效率类指标统计 -->
    <select id="selectEfficiencyMetricsStats" resultType="java.util.Map">
        SELECT 
            AVG(avg_retrieval_latency_ms) as avg_retrieval_latency,
            AVG(avg_rerank_latency_ms) as avg_rerank_latency,
            AVG(avg_generation_latency_ms) as avg_generation_latency,
            AVG(avg_e2e_latency_ms) as avg_e2e_latency,
            AVG(avg_input_tokens) as avg_input_tokens,
            AVG(avg_output_tokens) as avg_output_tokens,
            AVG(avg_cost_usd) as avg_cost_usd
        FROM t_rag_eval_metric 
        WHERE metric_category = 'efficiency'
        AND run_id IN
        <foreach collection="runIds" item="runId" open="(" separator="," close=")">
            #{runId}
        </foreach>
    </select>

    <!-- 删除运行的所有指标 -->
    <delete id="deleteByRunId" parameterType="java.lang.String">
        DELETE FROM t_rag_eval_metric WHERE run_id = #{runId}
    </delete>

    <!-- 删除指定运行和类别的指标 -->
    <delete id="deleteByRunIdAndCategory">
        DELETE FROM t_rag_eval_metric 
        WHERE run_id = #{runId} 
        AND metric_category = #{category}
    </delete>

</mapper>