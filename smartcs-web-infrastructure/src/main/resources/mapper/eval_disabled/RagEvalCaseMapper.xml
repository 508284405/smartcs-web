<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.leyue.smartcs.eval.mapper.RagEvalCaseMapper">

    <!-- RAG评估测试用例结果映射 -->
    <resultMap id="BaseResultMap" type="com.leyue.smartcs.eval.dataobject.RagEvalCaseDO">
        <id column="id" jdbcType="BIGINT" property="id"/>
        <result column="case_id" jdbcType="VARCHAR" property="caseId"/>
        <result column="dataset_id" jdbcType="VARCHAR" property="datasetId"/>
        <result column="question" jdbcType="LONGVARCHAR" property="question"/>
        <result column="expected_summary" jdbcType="LONGVARCHAR" property="expectedSummary"/>
        <result column="gold_evidence_refs" jdbcType="LONGVARCHAR" property="goldEvidenceRefs" typeHandler="com.baomidou.mybatisplus.extension.handlers.JacksonTypeHandler"/>
        <result column="ground_truth_contexts" jdbcType="LONGVARCHAR" property="groundTruthContexts" typeHandler="com.baomidou.mybatisplus.extension.handlers.JacksonTypeHandler"/>
        <result column="difficulty_tag" jdbcType="VARCHAR" property="difficultyTag"/>
        <result column="category" jdbcType="VARCHAR" property="category"/>
        <result column="query_type" jdbcType="VARCHAR" property="queryType"/>
        <result column="expected_retrieval_count" jdbcType="INTEGER" property="expectedRetrievalCount"/>
        <result column="evaluation_notes" jdbcType="LONGVARCHAR" property="evaluationNotes"/>
        <result column="metadata" jdbcType="LONGVARCHAR" property="metadata" typeHandler="com.baomidou.mybatisplus.extension.handlers.JacksonTypeHandler"/>
        <result column="status" jdbcType="TINYINT" property="status"/>
        <result column="is_deleted" jdbcType="TINYINT" property="isDeleted"/>
        <result column="created_by" jdbcType="BIGINT" property="createdBy"/>
        <result column="updated_by" jdbcType="BIGINT" property="updatedBy"/>
        <result column="created_at" jdbcType="BIGINT" property="createdAt"/>
        <result column="updated_at" jdbcType="BIGINT" property="updatedAt"/>
    </resultMap>

    <!-- 根据数据集ID查询测试用例列表 -->
    <select id="selectByDatasetId" parameterType="java.lang.String" resultMap="BaseResultMap">
        SELECT * FROM t_rag_eval_case 
        WHERE dataset_id = #{datasetId} 
        AND is_deleted = 0 
        ORDER BY created_at ASC
    </select>

    <!-- 根据难度标签查询测试用例列表 -->
    <select id="selectByDifficultyTag" parameterType="java.lang.String" resultMap="BaseResultMap">
        SELECT * FROM t_rag_eval_case 
        WHERE difficulty_tag = #{difficultyTag} 
        AND is_deleted = 0 
        ORDER BY created_at DESC
    </select>

    <!-- 根据类别查询测试用例列表 -->
    <select id="selectByCategory" parameterType="java.lang.String" resultMap="BaseResultMap">
        SELECT * FROM t_rag_eval_case 
        WHERE category = #{category} 
        AND is_deleted = 0 
        ORDER BY created_at DESC
    </select>

    <!-- 根据查询类型查询测试用例列表 -->
    <select id="selectByQueryType" parameterType="java.lang.String" resultMap="BaseResultMap">
        SELECT * FROM t_rag_eval_case 
        WHERE query_type = #{queryType} 
        AND is_deleted = 0 
        ORDER BY created_at DESC
    </select>

    <!-- 查询活跃测试用例列表（状态为1且未删除） -->
    <select id="selectActiveCases" resultMap="BaseResultMap">
        SELECT * FROM t_rag_eval_case 
        WHERE status = 1 
        AND is_deleted = 0 
        ORDER BY created_at DESC
    </select>

    <!-- 根据问题关键词搜索测试用例 -->
    <select id="selectByQuestionKeyword" parameterType="java.lang.String" resultMap="BaseResultMap">
        SELECT * FROM t_rag_eval_case 
        WHERE question LIKE CONCAT('%', #{keyword}, '%') 
        AND is_deleted = 0 
        ORDER BY created_at DESC
    </select>

    <!-- 统计数据集下的测试用例数量 -->
    <select id="countByDatasetId" parameterType="java.lang.String" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM t_rag_eval_case 
        WHERE dataset_id = #{datasetId} 
        AND is_deleted = 0
    </select>

    <!-- 统计活跃测试用例数量 -->
    <select id="countActiveCasesByDatasetId" parameterType="java.lang.String" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM t_rag_eval_case 
        WHERE dataset_id = #{datasetId} 
        AND status = 1 
        AND is_deleted = 0
    </select>

    <!-- 批量更新测试用例状态 -->
    <update id="batchUpdateStatus">
        UPDATE t_rag_eval_case 
        SET status = #{status}, updated_at = #{updatedAt}
        WHERE case_id IN
        <foreach collection="caseIds" item="caseId" open="(" separator="," close=")">
            #{caseId}
        </foreach>
    </update>

</mapper>