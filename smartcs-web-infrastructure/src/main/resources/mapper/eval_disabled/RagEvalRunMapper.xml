<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.leyue.smartcs.eval.mapper.RagEvalRunMapper">

    <!-- RAG评估运行结果映射 -->
    <resultMap id="BaseResultMap" type="com.leyue.smartcs.eval.dataobject.RagEvalRunDO">
        <id column="id" jdbcType="BIGINT" property="id"/>
        <result column="run_id" jdbcType="VARCHAR" property="runId"/>
        <result column="dataset_id" jdbcType="VARCHAR" property="datasetId"/>
        <result column="app_id" jdbcType="BIGINT" property="appId"/>
        <result column="provider_id" jdbcType="BIGINT" property="providerId"/>
        <result column="model_id" jdbcType="BIGINT" property="modelId"/>
        <result column="run_name" jdbcType="VARCHAR" property="runName"/>
        <result column="run_description" jdbcType="LONGVARCHAR" property="runDescription"/>
        <result column="run_type" jdbcType="VARCHAR" property="runType"/>
        <result column="evaluation_mode" jdbcType="VARCHAR" property="evaluationMode"/>
        <result column="rag_config_snapshot" jdbcType="LONGVARCHAR" property="ragConfigSnapshot" typeHandler="com.baomidou.mybatisplus.extension.handlers.JacksonTypeHandler"/>
        <result column="model_config_snapshot" jdbcType="LONGVARCHAR" property="modelConfigSnapshot" typeHandler="com.baomidou.mybatisplus.extension.handlers.JacksonTypeHandler"/>
        <result column="selected_metrics" jdbcType="LONGVARCHAR" property="selectedMetrics" typeHandler="com.baomidou.mybatisplus.extension.handlers.JacksonTypeHandler"/>
        <result column="total_cases" jdbcType="INTEGER" property="totalCases"/>
        <result column="completed_cases" jdbcType="INTEGER" property="completedCases"/>
        <result column="failed_cases" jdbcType="INTEGER" property="failedCases"/>
        <result column="status" jdbcType="VARCHAR" property="status"/>
        <result column="start_time" jdbcType="BIGINT" property="startTime"/>
        <result column="end_time" jdbcType="BIGINT" property="endTime"/>
        <result column="duration_ms" jdbcType="BIGINT" property="durationMs"/>
        <result column="error_message" jdbcType="LONGVARCHAR" property="errorMessage"/>
        <result column="progress_info" jdbcType="LONGVARCHAR" property="progressInfo" typeHandler="com.baomidou.mybatisplus.extension.handlers.JacksonTypeHandler"/>
        <result column="comparison_baseline_run_id" jdbcType="VARCHAR" property="comparisonBaselineRunId"/>
        <result column="initiator_id" jdbcType="BIGINT" property="initiatorId"/>
        <result column="initiator_name" jdbcType="VARCHAR" property="initiatorName"/>
        <result column="metadata" jdbcType="LONGVARCHAR" property="metadata" typeHandler="com.baomidou.mybatisplus.extension.handlers.JacksonTypeHandler"/>
        <result column="is_deleted" jdbcType="TINYINT" property="isDeleted"/>
        <result column="created_by" jdbcType="BIGINT" property="createdBy"/>
        <result column="updated_by" jdbcType="BIGINT" property="updatedBy"/>
        <result column="created_at" jdbcType="BIGINT" property="createdAt"/>
        <result column="updated_at" jdbcType="BIGINT" property="updatedAt"/>
    </resultMap>

    <!-- 根据数据集ID查询运行记录列表 -->
    <select id="selectByDatasetId" parameterType="java.lang.String" resultMap="BaseResultMap">
        SELECT * FROM t_rag_eval_run 
        WHERE dataset_id = #{datasetId} 
        AND is_deleted = 0 
        ORDER BY created_at DESC
    </select>

    <!-- 根据应用ID查询运行记录列表 -->
    <select id="selectByAppId" parameterType="java.lang.Long" resultMap="BaseResultMap">
        SELECT * FROM t_rag_eval_run 
        WHERE app_id = #{appId} 
        AND is_deleted = 0 
        ORDER BY created_at DESC
    </select>

    <!-- 根据模型ID查询运行记录列表 -->
    <select id="selectByModelId" parameterType="java.lang.Long" resultMap="BaseResultMap">
        SELECT * FROM t_rag_eval_run 
        WHERE model_id = #{modelId} 
        AND is_deleted = 0 
        ORDER BY created_at DESC
    </select>

    <!-- 根据发起人ID查询运行记录列表 -->
    <select id="selectByInitiatorId" parameterType="java.lang.Long" resultMap="BaseResultMap">
        SELECT * FROM t_rag_eval_run 
        WHERE initiator_id = #{initiatorId} 
        AND is_deleted = 0 
        ORDER BY created_at DESC
    </select>

    <!-- 根据运行类型查询运行记录列表 -->
    <select id="selectByRunType" parameterType="java.lang.String" resultMap="BaseResultMap">
        SELECT * FROM t_rag_eval_run 
        WHERE run_type = #{runType} 
        AND is_deleted = 0 
        ORDER BY created_at DESC
    </select>

    <!-- 根据状态查询运行记录列表 -->
    <select id="selectByStatus" parameterType="java.lang.String" resultMap="BaseResultMap">
        SELECT * FROM t_rag_eval_run 
        WHERE status = #{status} 
        AND is_deleted = 0 
        ORDER BY created_at DESC
    </select>

    <!-- 查询正在运行的评估记录 -->
    <select id="selectRunningRuns" resultMap="BaseResultMap">
        SELECT * FROM t_rag_eval_run 
        WHERE status IN ('pending', 'running') 
        AND is_deleted = 0 
        ORDER BY created_at DESC
    </select>

    <!-- 根据时间范围查询运行记录 -->
    <select id="selectByTimeRange" resultMap="BaseResultMap">
        SELECT * FROM t_rag_eval_run 
        WHERE start_time &gt;= #{startTime} 
        AND start_time &lt;= #{endTime}
        AND is_deleted = 0 
        ORDER BY start_time DESC
    </select>

    <!-- 查询最近的运行记录 -->
    <select id="selectRecentRuns" parameterType="java.lang.Integer" resultMap="BaseResultMap">
        SELECT * FROM t_rag_eval_run 
        WHERE is_deleted = 0 
        ORDER BY created_at DESC 
        LIMIT #{limit}
    </select>

    <!-- 根据数据集ID查询最近的运行记录 -->
    <select id="selectRecentRunsByDatasetId" resultMap="BaseResultMap">
        SELECT * FROM t_rag_eval_run 
        WHERE dataset_id = #{datasetId} 
        AND is_deleted = 0 
        ORDER BY created_at DESC 
        LIMIT #{limit}
    </select>

    <!-- 根据应用ID查询最近的运行记录 -->
    <select id="selectRecentRunsByAppId" resultMap="BaseResultMap">
        SELECT * FROM t_rag_eval_run 
        WHERE app_id = #{appId} 
        AND is_deleted = 0 
        ORDER BY created_at DESC 
        LIMIT #{limit}
    </select>

    <!-- 统计数据集的运行次数 -->
    <select id="countRunsByDatasetId" parameterType="java.lang.String" resultType="java.lang.Long">
        SELECT COUNT(*) FROM t_rag_eval_run 
        WHERE dataset_id = #{datasetId} 
        AND is_deleted = 0
    </select>

    <!-- 统计模型的运行次数 -->
    <select id="countRunsByModelId" parameterType="java.lang.Long" resultType="java.lang.Long">
        SELECT COUNT(*) FROM t_rag_eval_run 
        WHERE model_id = #{modelId} 
        AND is_deleted = 0
    </select>

    <!-- 统计应用的运行次数 -->
    <select id="countRunsByAppId" parameterType="java.lang.Long" resultType="java.lang.Long">
        SELECT COUNT(*) FROM t_rag_eval_run 
        WHERE app_id = #{appId} 
        AND is_deleted = 0
    </select>

    <!-- 更新运行状态 -->
    <update id="updateStatus">
        UPDATE t_rag_eval_run 
        SET status = #{status}, 
            updated_at = #{updatedAt}
            <if test="endTime != null">, end_time = #{endTime}</if>
            <if test="durationMs != null">, duration_ms = #{durationMs}</if>
            <if test="errorMessage != null">, error_message = #{errorMessage}</if>
        WHERE run_id = #{runId}
    </update>

    <!-- 更新运行进度 -->
    <update id="updateProgress">
        UPDATE t_rag_eval_run 
        SET completed_cases = #{completedCases},
            failed_cases = #{failedCases},
            progress_info = #{progressInfo,jdbcType=LONGVARCHAR,typeHandler=com.baomidou.mybatisplus.extension.handlers.JacksonTypeHandler},
            updated_at = #{updatedAt}
        WHERE run_id = #{runId}
    </update>

</mapper>