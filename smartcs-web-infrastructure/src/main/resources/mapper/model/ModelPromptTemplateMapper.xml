<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.leyue.smartcs.model.mapper.ModelPromptTemplateMapper">

    <!-- 根据模板标识查询 -->
    <select id="selectByTemplateKey" resultType="com.leyue.smartcs.model.dataobject.ModelPromptTemplateDO">
        SELECT *
        FROM t_model_prompt_template
        WHERE template_key = #{templateKey}
        AND is_deleted = 0
    </select>

    <!-- 检查模板标识是否已存在 -->
    <select id="countByTemplateKey" resultType="int">
        SELECT COUNT(*)
        FROM t_model_prompt_template
        WHERE template_key = #{templateKey}
        AND is_deleted = 0
        <if test="excludeId != null">
            AND id != #{excludeId}
        </if>
    </select>

    <!-- 根据模型类型查询活跃的模板 -->
    <select id="selectActiveByModelType" resultType="com.leyue.smartcs.model.dataobject.ModelPromptTemplateDO">
        SELECT *
        FROM t_model_prompt_template
        WHERE (model_types IS NULL 
               OR model_types = '' 
               OR FIND_IN_SET(#{modelType}, model_types) > 0 
               OR FIND_IN_SET('ALL', model_types) > 0)
        AND status = 'ACTIVE'
        AND is_deleted = 0
        ORDER BY created_at DESC
    </select>

    <!-- 查询系统内置模板 -->
    <select id="selectSystemTemplates" resultType="com.leyue.smartcs.model.dataobject.ModelPromptTemplateDO">
        SELECT *
        FROM t_model_prompt_template
        WHERE is_system = 1
        AND is_deleted = 0
        ORDER BY created_at DESC
    </select>

    <!-- 根据状态查询模板 -->
    <select id="selectByStatus" resultType="com.leyue.smartcs.model.dataobject.ModelPromptTemplateDO">
        SELECT *
        FROM t_model_prompt_template
        WHERE status = #{status}
        AND is_deleted = 0
        ORDER BY created_at DESC
    </select>

    <!-- 更新模板状态 -->
    <update id="updateStatus">
        UPDATE t_model_prompt_template
        SET status = #{status},
            updated_at = UNIX_TIMESTAMP(NOW()) * 1000
        WHERE id = #{id}
        AND is_deleted = 0
    </update>

</mapper>