<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.leyue.smartcs.model.mapper.ModelMapper">

    <!-- 根据提供商ID和模型标识查询 -->
    <select id="selectByProviderIdAndModelKey" resultType="com.leyue.smartcs.model.dataobject.ModelDO">
        SELECT *
        FROM t_model
        WHERE provider_id = #{providerId}
        AND model_key = #{modelKey}
        AND is_deleted = 0
    </select>

    <!-- 检查模型标识在指定提供商下是否已存在 -->
    <select id="countByProviderIdAndModelKey" resultType="int">
        SELECT COUNT(*)
        FROM t_model
        WHERE provider_id = #{providerId}
        AND model_key = #{modelKey}
        AND is_deleted = 0
        <if test="excludeId != null">
            AND id != #{excludeId}
        </if>
    </select>

    <!-- 根据提供商ID查询所有模型 -->
    <select id="selectByProviderId" resultType="com.leyue.smartcs.model.dataobject.ModelDO">
        SELECT *
        FROM t_model
        WHERE provider_id = #{providerId}
        AND is_deleted = 0
        ORDER BY created_at DESC
    </select>

    <!-- 根据模型类型查询活跃的模型实例 -->
    <select id="selectActiveByModelType" resultType="com.leyue.smartcs.model.dataobject.ModelDO">
        SELECT *
        FROM t_model
        WHERE model_type = #{modelType}
        AND status = 'active'
        AND deprecated = 0
        AND is_deleted = 0
        ORDER BY created_at DESC
    </select>

    <!-- 根据特性查询模型实例 -->
    <select id="selectByFeature" resultType="com.leyue.smartcs.model.dataobject.ModelDO">
        SELECT *
        FROM t_model
        WHERE FIND_IN_SET(#{feature}, features) > 0
        AND is_deleted = 0
        ORDER BY created_at DESC
    </select>

    <!-- 更新模型状态 -->
    <update id="updateStatus">
        UPDATE t_model
        SET status = #{status},
            updated_at = UNIX_TIMESTAMP(NOW()) * 1000
        WHERE id = #{id}
        AND is_deleted = 0
    </update>

</mapper>