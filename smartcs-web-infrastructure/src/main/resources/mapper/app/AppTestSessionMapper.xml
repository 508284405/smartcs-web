<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.leyue.smartcs.app.mapper.AppTestSessionMapper">
    
    <!-- 根据会话ID查询会话 -->
    <select id="selectBySessionId" resultType="com.leyue.smartcs.app.dataobject.AppTestSessionDO">
        SELECT * FROM t_app_test_session 
        WHERE session_id = #{sessionId} AND is_deleted = 0
    </select>
    
    <!-- 根据应用ID查询活跃会话列表 -->
    <select id="findActiveSessionsByAppId" resultType="com.leyue.smartcs.app.dataobject.AppTestSessionDO">
        SELECT * FROM t_app_test_session 
        WHERE app_id = #{appId} AND session_state = 'ACTIVE' AND is_deleted = 0
        ORDER BY last_message_time DESC
        <if test="limit != null">
            LIMIT #{limit}
        </if>
    </select>
    
    <!-- 根据用户ID查询会话列表 -->
    <select id="findSessionsByUserId" resultType="com.leyue.smartcs.app.dataobject.AppTestSessionDO">
        SELECT * FROM t_app_test_session 
        WHERE user_id = #{userId} AND is_deleted = 0
        ORDER BY last_message_time DESC
        <if test="limit != null">
            LIMIT #{limit}
        </if>
    </select>
    
    <!-- 更新会话消息统计 -->
    <update id="updateSessionStats">
        UPDATE t_app_test_session 
        SET message_count = #{messageCount},
            last_message_time = #{lastMessageTime},
            total_tokens = #{totalTokens},
            total_cost = #{totalCost},
            updated_at = #{lastMessageTime}
        WHERE session_id = #{sessionId} AND is_deleted = 0
    </update>
</mapper>