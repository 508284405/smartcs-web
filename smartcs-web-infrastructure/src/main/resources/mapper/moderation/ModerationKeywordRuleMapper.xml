<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.leyue.smartcs.moderation.mapper.ModerationKeywordRuleMapper">

    <!-- 关键词规则结果映射 -->
    <resultMap id="BaseResultMap" type="com.leyue.smartcs.moderation.dataobject.ModerationKeywordRuleDO">
        <id column="id" property="id" />
        <result column="rule_name" property="ruleName" />
        <result column="keywords" property="keywords" />
        <result column="category_id" property="categoryId" />
        <result column="language" property="language" />
        <result column="rule_type" property="ruleType" />
        <result column="priority" property="priority" />
        <result column="is_active" property="isActive" />
        <result column="hit_count" property="hitCount" />
        <result column="last_hit_at" property="lastHitAt" />
        <result column="effective_from" property="effectiveFrom" />
        <result column="effective_until" property="effectiveUntil" />
        <result column="created_at" property="createdAt" />
        <result column="updated_at" property="updatedAt" />
    </resultMap>

    <!-- 查找所有启用的关键词规则 -->
    <select id="findActiveKeywordRules" resultMap="BaseResultMap">
        SELECT * FROM t_moderation_keyword_rule 
        WHERE is_active = 1 
        ORDER BY priority ASC, id ASC
    </select>

    <!-- 根据分类ID查找关键词规则 -->
    <select id="findByCategoryId" resultMap="BaseResultMap">
        SELECT * FROM t_moderation_keyword_rule 
        WHERE category_id = #{categoryId} AND is_active = 1 
        ORDER BY priority ASC
    </select>

    <!-- 根据语言查找关键词规则 -->
    <select id="findByLanguage" resultMap="BaseResultMap">
        SELECT * FROM t_moderation_keyword_rule 
        WHERE language = #{language} AND is_active = 1 
        ORDER BY priority ASC
    </select>

    <!-- 根据规则类型查找关键词规则 -->
    <select id="findByRuleType" resultMap="BaseResultMap">
        SELECT * FROM t_moderation_keyword_rule 
        WHERE rule_type = #{ruleType} AND is_active = 1 
        ORDER BY priority ASC
    </select>

    <!-- 查找高优先级的关键词规则 -->
    <select id="findHighPriorityRules" resultMap="BaseResultMap">
        SELECT * FROM t_moderation_keyword_rule 
        WHERE priority &lt;= #{maxPriority} AND is_active = 1 
        ORDER BY priority ASC
    </select>

    <!-- 更新关键词规则的命中统计 -->
    <update id="updateHitStatistics">
        UPDATE t_moderation_keyword_rule 
        SET hit_count = #{hitCount}, last_hit_at = #{lastHitAt} 
        WHERE id = #{ruleId}
    </update>

    <!-- 批量更新规则的命中次数 -->
    <update id="incrementHitCount">
        UPDATE t_moderation_keyword_rule 
        SET hit_count = hit_count + 1, last_hit_at = #{currentTime} 
        WHERE id = #{ruleId}
    </update>

    <!-- 获取命中次数最多的规则（热点规则） -->
    <select id="findHotRules" resultMap="BaseResultMap">
        SELECT * FROM t_moderation_keyword_rule 
        WHERE is_active = 1 
        ORDER BY hit_count DESC 
        LIMIT #{topN}
    </select>

    <!-- 根据有效时间查找规则 -->
    <select id="findEffectiveRules" resultMap="BaseResultMap">
        SELECT * FROM t_moderation_keyword_rule
        WHERE is_active = 1 
        AND (effective_from IS NULL OR effective_from &lt;= #{currentTime}) 
        AND (effective_until IS NULL OR effective_until > #{currentTime}) 
        ORDER BY priority ASC
    </select>

    <!-- 查找即将过期的规则 -->
    <select id="findRulesExpiringSoon" resultMap="BaseResultMap">
        SELECT * FROM t_moderation_keyword_rule 
        WHERE effective_until IS NOT NULL 
        AND effective_until BETWEEN #{startTime} AND #{endTime}
    </select>

    <!-- 统计各分类下的规则数量 -->
    <select id="countRulesByCategory" resultType="java.util.Map">
        SELECT c.name as categoryName, c.code as categoryCode, COUNT(r.id) as ruleCount 
        FROM t_moderation_category c 
        LEFT JOIN t_moderation_keyword_rule r ON c.id = r.category_id AND r.is_active = 1 
        WHERE c.is_active = 1 
        GROUP BY c.id, c.name, c.code 
        ORDER BY ruleCount DESC
    </select>

    <!-- 删除过期的规则 -->
    <update id="deactivateExpiredRules">
        UPDATE t_moderation_keyword_rule 
        SET is_active = 0 
        WHERE effective_until &lt; #{currentTime}
    </update>

</mapper>
