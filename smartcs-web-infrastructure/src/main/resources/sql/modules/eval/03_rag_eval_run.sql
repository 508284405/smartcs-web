-- RAG评估运行记录表
-- 用于记录每次评估运行的配置和状态
CREATE TABLE `t_rag_eval_run` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '运行记录ID',
  `run_id` VARCHAR(64) NOT NULL COMMENT '运行唯一标识符',
  `dataset_id` VARCHAR(64) NOT NULL COMMENT '使用的数据集ID',
  `app_id` BIGINT COMMENT '关联的AI应用ID',
  `provider_id` BIGINT COMMENT '使用的模型提供商ID',
  `model_id` BIGINT COMMENT '使用的模型ID',
  `run_name` VARCHAR(128) COMMENT '运行名称',
  `run_description` TEXT COMMENT '运行描述',
  `run_type` VARCHAR(32) NOT NULL COMMENT '运行类型：retrieval, generation, e2e, ab_test',
  `evaluation_mode` VARCHAR(32) DEFAULT 'offline' COMMENT '评估模式：offline, online',
  `rag_config_snapshot` JSON COMMENT 'RAG配置快照（检索、重排序、生成参数）',
  `model_config_snapshot` JSON COMMENT '模型配置快照',
  `selected_metrics` JSON COMMENT '选择的评估指标列表',
  `total_cases` INT DEFAULT 0 COMMENT '总测试用例数',
  `completed_cases` INT DEFAULT 0 COMMENT '已完成用例数',
  `failed_cases` INT DEFAULT 0 COMMENT '失败用例数',
  `status` VARCHAR(32) DEFAULT 'pending' COMMENT '状态：pending, running, completed, failed, cancelled',
  `start_time` BIGINT COMMENT '开始时间（毫秒时间戳）',
  `end_time` BIGINT COMMENT '结束时间（毫秒时间戳）',
  `duration_ms` BIGINT COMMENT '运行时长（毫秒）',
  `error_message` TEXT COMMENT '错误信息',
  `progress_info` JSON COMMENT '进度信息',
  `comparison_baseline_run_id` VARCHAR(64) COMMENT 'A/B测试时的基准运行ID',
  `initiator_id` BIGINT COMMENT '发起人用户ID',
  `initiator_name` VARCHAR(64) COMMENT '发起人姓名',
  `metadata` JSON COMMENT '扩展元数据',
  `is_deleted` TINYINT DEFAULT 0 COMMENT '是否删除：0-否，1-是',
  `created_by` BIGINT COMMENT '创建人',
  `updated_by` BIGINT COMMENT '更新人',
  `created_at` BIGINT NOT NULL COMMENT '创建时间（毫秒时间戳）',
  `updated_at` BIGINT NOT NULL COMMENT '更新时间（毫秒时间戳）',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_run_id` (`run_id`),
  KEY `idx_dataset_id` (`dataset_id`),
  KEY `idx_app_id` (`app_id`),
  KEY `idx_run_type_status` (`run_type`, `status`),
  KEY `idx_initiator_created` (`initiator_id`, `created_at`),
  KEY `idx_start_time` (`start_time`),
  CONSTRAINT `fk_eval_run_dataset` FOREIGN KEY (`dataset_id`) REFERENCES `t_rag_eval_dataset` (`dataset_id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='RAG评估运行记录表';