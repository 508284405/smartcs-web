
8. Knowledge-Service 模块详细设计

8.1 模块简介

Knowledge-Service 负责 FAQ 与文档的管理、向量化处理、向量检索接口和与 Bot-Service 的上下文打通，是智能客服 RAG 流程的核心支撑组件。

8.2 核心职责
	•	FAQ 与文档元数据管理（创建/编辑/删除/版本）
	•	文档分段、切片，生成并更新向量（Embedding）
	•	向量入库与索引管理（Milvus/FAISS）
	•	提供向量检索（Top-K）与全文检索接口
	•	文档与 FAQ 的关联推荐（基于关键词或向量相似度）
	•	向 Bot-Service 提供语义检索结果和原始文本回填

8.3 架构组件

flowchart TB
  subgraph Knowledge-Service
    API[REST & GRPC 接口层]
    Core[核心业务逻辑]
    EmbWorker[Embedding 计算 Worker]
    VecDB[向量数据库 SDK]
    ESClient[Elasticsearch 客户端]
    DBWriter[MySQL 写入层]
    Cache[Redis 缓存层]
  end
  subgraph Infra
    Milvus[(Milvus / FAISS)]
    ES[(Elasticsearch)]
    MySQL[(MySQL 主从)]
    Redis[(Redis Cluster)]
  end

  API --> Core
  Core --> DBWriter
  Core --> EmbWorker
  EmbWorker --> VecDB
  Core --> ESClient
  Core --> Cache
  VecDB --> Milvus
  ESClient --> ES
  DBWriter --> MySQL
  Cache --> Redis

	•	API：对外提供文档 & FAQ 管理、索引触发与检索接口；支持同步 RPC（Bot-Service 调用）及异步 Webhook。
	•	Core：实现文档分片、向量化策略、检索路由（关键词 vs. 向量）、版本管理、缓存失效。
	•	EmbWorker：独立容器/Pod，调用外部 Embedding 服务（OpenAI Embedding、BGE、E5 等），结果回写 MySQL & 向量库。
	•	VecDB SDK：封装 Milvus/FAISS 的批量写入、索引配置 (HNSW/IVF)，并提供向量查询接口。
	•	ESClient：同步文档元数据与全文索引，支持关键词快速检索和备份。
	•	DBWriter：管理 MySQL 中 cs_faq、cs_doc、cs_doc_embedding 等表的写入与事务。
	•	Cache：对热门 FAQ 问题、文档片段检索结果做短期缓存 (TTL 5–30min)。

8.4 数据模型

cs_faq

字段	类型	描述
id	BIGINT	主键，自增
is_deleted	TINYINT(1)	逻辑删除
created_by	VARCHAR(64)	创建者
updated_by	VARCHAR(64)	更新者
created_at	BIGINT	创建时间（ms）
updated_at	BIGINT	更新时间（ms）
question	VARCHAR(255)	常见问题文本
answer	TEXT	标准答案
hit_count	BIGINT	命中次数
version	INT	版本号

cs_doc

字段	类型	描述
id	BIGINT	主键，自增
is_deleted	TINYINT(1)	逻辑删除
created_by	VARCHAR(64)	创建者
updated_by	VARCHAR(64)	更新者
created_at	BIGINT	创建时间（ms）
updated_at	BIGINT	更新时间（ms）
title	VARCHAR(255)	文档标题
oss_url	VARCHAR(512)	OSS 存储地址
version	INT	文档版本

cs_doc_embedding

字段	类型	描述
id	BIGINT	主键，自增
is_deleted	TINYINT(1)	逻辑删除
created_by	VARCHAR(64)	创建者
updated_by	VARCHAR(64)	更新者
created_at	BIGINT	创建时间（ms）
updated_at	BIGINT	更新时间（ms）
doc_id	BIGINT	外键，所属文档 ID
section_idx	INT	段落序号
content_snip	TEXT	文本片段
vector	BLOB	向量数据（FLOAT4[]，维度按模型决定）

8.5 接口设计

方法	路径	描述	参数示例
POST	/api/knowledge/faq	创建/更新 FAQ	{question, answer}
GET	/api/knowledge/faq	查询 FAQ 列表（分页/搜索）	page, size, question
DELETE	/api/knowledge/faq/{id}	删除 FAQ	id
POST	/api/knowledge/doc	上传文档并触发分段 embedding	multipart file, title, version
GET	/api/knowledge/doc	列表文档元数据（分页/搜索）	page, size, title
GET	/api/knowledge/doc/{id}/sections	获取文档分段 & 向量检索结果	k, modelType
POST	/api/knowledge/embeddings/batch	批量生成并写入向量	[{docId, sectionIdx, content}]
POST	/api/knowledge/search/vector	向量检索 Top-K	{queryVector, k}
POST	/api/knowledge/search/text	全文检索 Top-K	{keyword, k}

8.6 业务流程

sequenceDiagram
  participant Admin
  participant API
  participant Core
  participant EmbWorker
  participant VecDB
  participant DB
  participant ES

  Admin->>API: POST /api/knowledge/doc {file}
  API->>Core: save metadata & version
  Core->>DB: insert cs_doc
  Core->>EmbWorker: dispatch embedding task
  EmbWorker->>Core: return section vectors
  Core->>DB: insert cs_doc_embedding
  Core->>VecDB: write vectors to Milvus
  Core->>ES: index doc metadata
  API-->>Admin: 201 Created + docId

  Admin->>API: POST /api/knowledge/search/vector {vector,k}
  API->>Core: vectorSearch()
  Core->>VecDB: search top-k
  VecDB-->>Core: ids + scores
  Core->>DB: load content_snip for each id
  Core-->>Admin: 返回段落列表

8.7 性能与可用性
	•	并发处理：EmbWorker 弹性扩缩容，支持批量任务 & 限流（Semaphore），避免调用 Embedding 服务过载。
	•	检索加速：Milvus 配置 HNSW 索引（M=16、ef=200），支撑 P99 < 120 ms，QPS ≥ 300。
	•	缓存热点：Redis 缓存热门 FAQ & Top-K 检索结果，减少向量库与 DB 访问。
	•	读写分离：MySQL 主从架构；向量库和 ES 可水平扩展。
	•	降级策略：Embedding 服务不可用时，退回全文检索；检索失败时，返回预设 FAQ。

8.8 安全与合规
	•	权限校验：接口必须携带 JWT，管理员角色才能增删改；普通用户仅可搜索。
	•	输入过滤：文件上传做病毒扫描，文本内容做 XSS 防护与长度校验。
	•	数据脱敏：文档中若包含敏感信息，自动脱敏或标记。
	•	审计日志：所有增删改操作写入审计表或 Kafka，用于合规与回溯。

⸻

如需进一步示例代码、SDK 使用示例或 Helm 部署模板，请告知！