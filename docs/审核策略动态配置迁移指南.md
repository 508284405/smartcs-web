# 审核策略动态配置迁移指南

本文档说明了如何从硬编码的审核prompt迁移到基于策略配置的动态prompt生成系统。

## 迁移概述

### 迁移目标
- 将LangChain4jModerationService中硬编码的审核维度转换为可配置的策略系统
- 实现动态prompt生成，支持多场景、多策略的灵活配置
- 保持向后兼容性，确保现有功能正常运行

### 核心改进
1. **动态prompt生成**：基于策略配置和模板动态生成审核prompt
2. **策略化管理**：支持多种审核策略，适配不同业务场景
3. **维度可配置**：审核维度可以灵活配置、启用/禁用
4. **模板化支持**：支持多语言、多格式的prompt模板

## 迁移步骤

### 1. 数据库迁移
执行以下SQL脚本完成数据结构迁移：

```bash
# 1. 创建新的表结构
mysql -u username -p database_name < smartcs-web-infrastructure/src/main/resources/sql/modules/moderation/05_moderation_policy.sql

# 2. 执行数据迁移
mysql -u username -p database_name < smartcs-web-infrastructure/src/main/resources/sql/migration/003_migrate_hardcoded_moderation.sql
```

### 2. 代码更新
重构后的主要组件：

#### 新增组件
- **ModerationPolicy**: 审核策略领域实体
- **ModerationDimension**: 审核维度领域实体  
- **ModerationPolicyTemplate**: 策略模板领域实体
- **ModerationPolicyService**: 策略管理领域服务
- **ModerationPromptGenerator**: 动态prompt生成服务

#### 重构组件
- **LangChain4jModerationService**: 
  - 支持动态prompt生成
  - 保持原有接口兼容性
  - 新增场景参数支持

### 3. 配置更新

#### 应用配置
在application.yaml中添加以下配置：

```yaml
moderation:
  ai:
    enabled: true
    timeout-seconds: 10
    model-name: gpt-3.5-turbo
    default-scenario: USER_CHAT  # 新增：默认审核场景
    
  policy:
    enable-dynamic-prompt: true  # 新增：启用动态prompt
    fallback-to-hardcoded: true  # 新增：失败时回退到硬编码prompt
```

### 4. 接口调用更新

#### 原有调用方式（保持兼容）
```java
// 现有调用方式继续有效
CompletableFuture<AiModerationResult> result = 
    moderationService.moderateContent(content, modelId);
```

#### 新的调用方式
```java
// 指定场景的审核
CompletableFuture<AiModerationResult> result = 
    moderationService.moderateContent(content, modelId, "USER_CHAT");

// 快速审核（支持语言参数）
CompletableFuture<QuickModerationResult> quickResult = 
    moderationService.quickModerate(content, modelId, "zh-CN");
```

## 验证迁移结果

### 1. 数据库验证
```sql
-- 查看迁移状态
SELECT * FROM v_moderation_policy_migration_status;

-- 查看迁移记录
SELECT migration_type, JSON_EXTRACT(backup_data, '$.status') as status, created_at 
FROM t_moderation_migration_backup 
ORDER BY created_at DESC;

-- 验证策略配置
SELECT p.name, p.code, COUNT(pd.dimension_id) as dimension_count
FROM t_moderation_policy p
LEFT JOIN t_moderation_policy_dimension pd ON p.id = pd.policy_id AND pd.is_active = 1
WHERE p.is_active = 1
GROUP BY p.id, p.name, p.code;
```

### 2. 功能验证
1. **基础审核功能**：确保现有审核接口正常工作
2. **策略选择**：验证不同场景选择正确的策略
3. **prompt生成**：验证动态生成的prompt包含正确的维度
4. **模板渲染**：验证模板变量替换正常工作

### 3. 性能验证
- 对比迁移前后的响应时间
- 验证prompt生成的缓存机制
- 检查数据库查询性能

## 管理界面使用

### 策略管理
```bash
# 查看所有策略
GET /admin/moderation/policies

# 创建新策略  
POST /admin/moderation/policies
{
  "name": "严格内容审核",
  "code": "STRICT_CONTENT_REVIEW", 
  "scenario": "CONTENT_PUBLISH",
  "policyType": "STRICT"
}

# 配置策略维度
POST /admin/moderation/policies/{id}/dimensions
[
  {
    "dimensionId": 1,
    "isActive": true,
    "weight": 1.0,
    "customThreshold": 0.7
  }
]
```

### 维度管理
```bash
# 查看所有维度
GET /admin/moderation/policies/dimensions

# 查看策略关联的维度
GET /admin/moderation/policies/{id}/dimensions
```

## 回退方案

如果迁移过程中出现问题，可以通过以下方式回退：

### 1. 禁用动态prompt
```yaml
moderation:
  policy:
    enable-dynamic-prompt: false
    fallback-to-hardcoded: true
```

### 2. 数据库回退
```sql
-- 禁用所有策略（使其回退到硬编码逻辑）
UPDATE t_moderation_policy SET is_active = 0;

-- 恢复备份（如果需要）
-- 具体步骤根据备份情况确定
```

### 3. 代码回退
- 恢复LangChain4jModerationService到迁移前的版本
- 移除新增的策略相关代码

## 注意事项

### 1. 迁移准备
- 在生产环境迁移前，务必在测试环境完整验证
- 备份现有的审核记录和配置
- 准备详细的回退计划

### 2. 兼容性
- 现有的审核接口保持100%向后兼容
- 原有的审核记录格式不变
- 客户端代码无需修改

### 3. 性能考虑
- 动态prompt生成会增加少量计算开销
- 建议配置适当的缓存策略
- 监控数据库查询性能

### 4. 监控要点
- 策略选择的正确性
- Prompt生成的成功率
- 审核结果的一致性
- 系统响应时间变化

## 故障排查

### 常见问题

1. **策略未找到**
   - 检查场景配置是否正确
   - 验证策略的启用状态
   - 确认策略优先级设置

2. **维度缺失**
   - 检查策略维度关联配置
   - 验证维度的启用状态
   - 确认维度排序权重

3. **模板渲染失败**
   - 检查模板语法是否正确
   - 验证变量定义是否完整
   - 确认模板与策略的关联

4. **性能问题**
   - 启用查询缓存
   - 优化数据库索引
   - 检查N+1查询问题

通过以上步骤，可以顺利完成从硬编码到动态配置的迁移，实现更加灵活和可维护的审核系统。