# RAG 意图识别（单轮/多轮）技术分析与系统评估

本文聚焦 SmartCS 的意图识别能力在 RAG 链路中的定位、实现与完善程度，给出改进建议与落地路线。

## 背景与最佳实践

- 单轮识别：
  - 任务：判断是否检索（闲聊/问候绕过）、确定检索策略（TopK、阈值、过滤标签）、选择路由（知识库/Web/SQL）。
  - 技术：关键词/规则 + 领域词典 + LLM 分类（结构化输出）+ 置信度阈值与回退。
  - 输出：意图编码、目录、置信度、理由；可附查询类型（问答/对比/汇总等）与关键实体/槽位。

- 多轮识别：
  - 任务：在会话上下文下做消歧与槽位补全；维护“进行中的意图”，生成澄清问题；当必填槽位缺失时阻断检索。
  - 技术：会话记忆（窗口/摘要）、历史意图/槽位状态机、澄清对话（问题模板/LLM 生成）、多回合阈值控制与超时/预算治理。
  - 输出：当前意图状态（进行中/已完成/超时）、缺失槽位列表、澄清问题、是否阻断检索标志。

## 当前实现概览

- 领域与应用
  - 分类领域服务：`smartcs-web-domain/.../ClassificationDomainService.java:23` 通过快照网关装配上下文后委托网关完成分类。
  - 管理与测试：`smartcs-web-app/.../IntentClassificationServiceImpl.java:23` 提供单条/批量分类、运行时配置查询、困难样本上报；`IntentServiceImpl` 含槽位模板维护与测试逻辑。

- 基础设施（LLM 分类 + 回退 + 缓存）
  - 网关实现：`smartcs-web-infrastructure/.../IntentClassificationGatewayImpl.java:1` 基于 LangChain4j 的声明式 AI Service 实现两级（目录/意图）分类，支持批量、重试、解析、Redisson 缓存、规则回退与指标日志。
  - AI 服务接口：`smartcs-web-infrastructure/.../intent/ai/IntentClassificationAiService.java:1` 使用 `@SystemMessage/@UserMessage` 约束严格 JSON 输出（单条/批量/相似度）。

- 查询转换管线（Pipeline）
  - 配置装配：`smartcs-web-infrastructure/.../QueryTransformerConfiguration.java:1` 定义默认阶段（标准化、拼音纠错、前缀补全、同义词召回、语义对齐、意图抽取、槽位填充、可检索化改写、扩展策略），可通过属性切换为传统模式；默认启用 `enableIntentRecognition` 与 `enableSlotFilling`。
  - 阶段实现：
    - 意图抽取：`.../stages/IntentExtractionStage.java:1` 字典优先 + LLM 回退，抽取意图/目录/置信度/查询类型/实体/结构化槽位与过滤条件，写入上下文属性（含 `intentStats`）。
    - 槽位填充：`.../stages/SlotFillingStage.java:1` 按意图槽位模板识别缺失槽位，生成澄清问题，支持“缺失则阻断检索”，将结果写入 `attributes.slot_filling`。
    - 扩展策略：`.../stages/ExpansionStrategyStage.java:1` 多路 query、Step-back、HyDE、基于上下文扩展（会利用 `intentStats`）。

- RAG 组装工厂
  - `smartcs-web-infrastructure/.../RagAugmentorFactory.java:1` 组装 `RetrievalAugmentor`、`QueryTransformerPipeline`、`QueryRouter` 等，供 `SmartChatService` 使用。
  - 重要差异：在该工厂内，`IntentExtractionStage` 暂时禁用（“避免循环依赖”备注）。因此聊天路径默认未启用意图抽取/槽位填充阶段，且未注入 `DictionaryService`（以 `null` 传入）。

- 会话与聊天
  - 聊天执行器：`smartcs-web-app/.../AiAppChatCmdExe.java:1` 使用 `RagAugmentorFactory` 创建增强器与聊天服务；集成内容审核与记忆（`ChatMemoryStore`）。
  - 上下文对象：`.../QueryTransformerPipeline.java:138` 中 `QueryContext` 包含 `chatHistory`、`attributes` 等，但目前各阶段未使用 `chatHistory` 做多轮意图。

## 单轮 vs 多轮能力评估

- 单轮识别（较完善）
  - LLM 两级分类：分类提示与解析较完备，含重试、回退、阈值与缓存（参考 `IntentClassificationGatewayImpl`）。
  - 词典增强：`IntentExtractionStage` 提供模式/关键词匹配与领域术语增强，但在聊天主路径中暂未启用该阶段，且 `DictionaryService` 未注入。
  - 策略联动：`ExpansionStrategyStage` 支持依据意图统计做扩展，但依赖前置意图抽取阶段产出。

- 多轮识别（能力尚未打通）
  - 记忆与上下文：`QueryContext` 已留有 `chatHistory`，但意图/槽位阶段未利用历史轮次；无“进行中的意图”管理与会话状态机。
  - 槽位澄清链路：`SlotFillingStage` 仅将 `slot_filling` 写入上下文，聊天层（`AiAppChatCmdExe`/SSE）未读取并触发“澄清问句→等待用户答复→补全再检索”的多轮闭环。
  - 运行时决策：`IntentAwareRagService` 提供“按意图优化 RAG 参数”的思路，但未集成至聊天执行路径。

## 完整度结论

- 已具备：
  - 面向单轮的 LLM 两级分类与规则回退、批量接口、快照与目录抽象、重试与缓存治理。
  - 可扩展的查询转换管线骨架与阶段拆分（含意图/槽位/策略等）。
  - 槽位模板与澄清问题生成的基础能力与测试用例。

- 存在缺口：
  - 运行时路径不一致：聊天主链路通过 `RagAugmentorFactory` 构建的管线未启用 `IntentExtractionStage`，导致后续阶段（如策略/槽位）无法获得意图上下文。
  - 多轮未落地：`chatHistory` 未被消费；`slot_filling` 未被聊天层读取执行澄清；缺少“进行中意图/槽位状态”在会话内的存取与续写。
  - 词典与配置：聊天路径未注入 `DictionaryService`；`application.yaml` 中缺少与 `QueryTransformerConfiguration` 对齐的开关项（如 `smartcs.rag.query-transformer.enable-pipeline`）。

## 关键文件参考

- 查询管线装配：
  - `smartcs-web-infrastructure/src/main/java/com/leyue/smartcs/rag/config/QueryTransformerConfiguration.java:1`
  - `smartcs-web-infrastructure/src/main/java/com/leyue/smartcs/rag/factory/RagAugmentorFactory.java:318`

- 意图/槽位阶段：
  - `smartcs-web-infrastructure/src/main/java/com/leyue/smartcs/rag/query/pipeline/stages/IntentExtractionStage.java:1`
  - `smartcs-web-infrastructure/src/main/java/com/leyue/smartcs/rag/query/pipeline/stages/SlotFillingStage.java:1`

- LLM 分类与回退：
  - `smartcs-web-infrastructure/src/main/java/com/leyue/smartcs/intent/gateway/IntentClassificationGatewayImpl.java:1`
  - `smartcs-web-infrastructure/src/main/java/com/leyue/smartcs/intent/ai/IntentClassificationAiService.java:1`

- 聊天执行与记忆：
  - `smartcs-web-app/src/main/java/com/leyue/smartcs/app/executor/AiAppChatCmdExe.java:1`
  - `smartcs-web-infrastructure/src/main/java/com/leyue/smartcs/rag/SmartChatService.java:1`

## 改进建议与路线图

- M0（打通主链路，低风险变更）
  - 统一管线来源：
    - 将 `RagAugmentorFactory` 改为优先注入使用 Spring 上下文中的 `QueryTransformer` Bean（`QueryTransformerConfiguration`），确保聊天路径与配置一致；或在工厂内启用 `IntentExtractionStage` 并注入 `DictionaryService`，消除“暂时禁用”状态。
  - 最小化多轮闭环：
    - 在 `AiAppChatCmdExe` 获取管线执行后的 `attributes.slot_filling`，当 `block_retrieval=true` 或存在 `questions` 时，优先返回澄清问题（SSE data/complete）并缓存“进行中意图 + 缺失槽位”到 `ChatMemoryStore`，等待用户下一轮补全。

- M1（会话级意图与槽位状态）
  - 引入会话意图跟踪器：在 `ChatMemory` 中持久化 `currentIntent`、`slots{filled/missing}`、`clarificationCount`、`deadline`；`IntentExtractionStage` 可读取历史填充状态补全识别。
  - 历史感知分类：`IntentClassificationAiService` 的 prompt 增补“上轮意图与已填槽位”上下文，降低多轮误判率。
  - 阈值与预算：针对多轮澄清设定最大回合/超时与 token/cost 预算，结合 `QueryContext.BudgetControl/TimeoutControl` 执行。

- M2（策略与评估）
  - 策略联动：将 `IntentAwareRagService` 的“按意图优化 RAG 参数”并入管线/增强器配置（TopK、阈值、路由器开关）。
  - 观测与门禁：为“意图→检索→答案”链路埋点，纳入 CI 的“RAG Quality Gate”；补齐 `application.yaml` 开关项（如 `smartcs.rag.query-transformer.enable-pipeline`、`smartcs.intent.*`）。
  - 测试补齐：新增 `IntentExtractionStage` 与多轮澄清的集成测试；回归验证 `SlotFillingStageTest` 的阻断场景与问题生成质量。

## 结论

- 系统已具备较完整的“单轮意图识别 + 回退治理 + 管线化扩展”基础设施与领域抽象，但聊天主路径未启用意图/槽位阶段，导致策略联动与多轮澄清价值未落地。
- 建议优先完成管线统一与最小闭环澄清（M0），随后引入会话状态与历史感知分类（M1），最终完善策略联动与评估闭环（M2）。

## 已落地优化（M0/M1/M2）

- M0（已完成）
  - 统一聊天主链路的查询转换管线：`RagAugmentorFactory` 启用 `IntentExtractionStage` 与 `SlotFillingStage`，并注入 `DictionaryService`/`DynamicModelManager`/`ObjectMapper`/`SlotFillingMetricsCollector`，同时为各阶段补齐字典依赖（语义对齐、拼音改写、前缀补全、近义词、可检索化改写）。文件：
    - `smartcs-web-infrastructure/src/main/java/com/leyue/smartcs/rag/factory/RagAugmentorFactory.java:1`
  - 最小澄清闭环：在 `AiAppChatCmdExe` 调用 RAG 前执行一次 `QueryTransformerPipeline.transformWithTrace`，捕获 `slot_filling`，若需要澄清则直接以 SSE 返回问题并终止本轮推理。文件：
    - `smartcs-web-app/src/main/java/com/leyue/smartcs/app/executor/AiAppChatCmdExe.java:1`
  - 配置开关：启用管线 Bean 条件加载。文件：
    - `start/src/main/resources/application.yaml:1` 新增 `smartcs.rag.query-transformer.enable-pipeline: true`
  - 支撑：为 `QueryTransformationTrace` 增加 `attributesSnapshot`，用于外部读取阶段产出。文件：
    - `smartcs-web-infrastructure/src/main/java/com/leyue/smartcs/rag/query/pipeline/QueryTransformationTrace.java:1`
    - `smartcs-web-infrastructure/src/main/java/com/leyue/smartcs/rag/query/pipeline/QueryTransformerPipeline.java:179`

- M1（已完成最小版）
  - 会话ID复用：`AiAppChatCmdExe` 支持前端传入 `sessionId`，未提供则生成，用于多轮上下文连续。文件：
    - `smartcs-web-app/src/main/java/com/leyue/smartcs/app/executor/AiAppChatCmdExe.java:1`
  - 会话级意图/槽位状态存储（内存）：新增 `SessionIntentStateStore`，在需要澄清时缓存 `slot_filling` 信息，供后续轮次读取。文件：
    - `smartcs-web-app/src/main/java/com/leyue/smartcs/intent/service/SessionIntentStateStore.java:1`

- M2（部分落地）
  - 策略联动基础：扩展阶段已可读取 `IntentExtractionStage` 写入的 `intentStats`，并通过 `ExpansionStrategyStage` 进行多路扩展与上下文增强（原有能力，现在通过M0打通）。
  - 配置治理：为管线启用配置开关，后续可继续补齐 `smartcs.intent.*` 与评估门禁。

后续建议（未改动但建议继续）
- 将 `SessionIntentStateStore` 状态注入到下一轮 `QueryContext.attributes`，用于自动补全/消歧（需要在管线创建时注入会话态）。
- 将 `IntentAwareRagService` 策略落地到 `RagAugmentorFactory` 创建参数（TopK/阈值/路由开关）。
