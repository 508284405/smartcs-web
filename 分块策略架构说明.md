# 分块策略架构重构说明

## 概述

为了解决原有分块策略无法灵活适应不同文档类型的问题，我们重新设计了分块架构，支持根据文档类型自由定义和组合多种分块策略。

## 架构设计

### 1. 核心接口和类

#### ChunkingStrategy (分块策略接口)
- **位置**: `smartcs-web-domain/src/main/java/com/leyue/smartcs/knowledge/domain/chunking/ChunkingStrategy.java`
- **功能**: 定义分块策略的标准接口
- **关键方法**:
  - `chunk()`: 执行分块处理
  - `getSupportedDocumentTypes()`: 获取支持的文档类型
  - `isCombinable()`: 是否可与其他策略组合
  - `validateConfig()`: 验证配置有效性

#### ChunkingPipeline (分块管道)
- **位置**: `smartcs-web-domain/src/main/java/com/leyue/smartcs/knowledge/domain/chunking/ChunkingPipeline.java`
- **功能**: 支持多个策略按配置顺序串联执行
- **特点**: 
  - 策略链式执行
  - 支持并行处理
  - 动态管道构建

#### ChunkingStrategyRegistry (策略注册器)
- **位置**: `smartcs-web-domain/src/main/java/com/leyue/smartcs/knowledge/domain/chunking/ChunkingStrategyRegistry.java`
- **功能**: 管理所有可用分块策略
- **实现**: `smartcs-web-infrastructure/src/main/java/com/leyue/smartcs/knowledge/chunking/ChunkingStrategyRegistryImpl.java`

#### DocumentTypeChunkingConfig (文档类型分块配置)
- **位置**: `smartcs-web-domain/src/main/java/com/leyue/smartcs/knowledge/domain/chunking/DocumentTypeChunkingConfig.java`
- **功能**: 定义每种文档类型的分块策略组合配置

### 2. 具体策略实现

#### TextContentChunkingStrategy (文本内容分块)
- **位置**: `smartcs-web-infrastructure/src/main/java/com/leyue/smartcs/knowledge/chunking/strategy/TextContentChunkingStrategy.java`
- **支持文档类型**: TXT, MARKDOWN, MDX, HTML, HTM, DOCX, PDF
- **功能**: 
  - 递归文本分割
  - 句子边界对齐
  - 可配置块大小和重叠

#### TableProcessingStrategy (表格处理分块)
- **位置**: `smartcs-web-infrastructure/src/main/java/com/leyue/smartcs/knowledge/chunking/strategy/TableProcessingStrategy.java`
- **支持文档类型**: CSV, XLSX, XLS, HTML, HTM
- **功能**:
  - HTML表格智能分块
  - CSV行级别处理
  - 表头保留选项
  - 上下文提取

#### ImageProcessingStrategy (图像处理分块)
- **位置**: `smartcs-web-infrastructure/src/main/java/com/leyue/smartcs/knowledge/chunking/strategy/ImageProcessingStrategy.java`
- **支持文档类型**: PDF, HTML, HTM, MARKDOWN, MDX, DOCX
- **功能**:
  - 图像提取和识别
  - OCR文字识别（可选）
  - 图像描述生成（可选）
  - 元数据提取

## 使用方式

### 1. 命令参数扩展

在 `KnowledgeGeneralChunkCmd` 中新增了 `chunkingStrategies` 字段：

```java
/**
 * 自定义分块策略列表
 * 可以指定多个策略组合使用，如: ["IMAGE_PROCESSING", "TABLE_PROCESSING", "TEXT_CONTENT"]
 * 如果为空，将使用文档类型的默认策略组合
 */
private List<String> chunkingStrategies;
```

### 2. API调用示例

#### 使用默认策略组合
```json
{
  "fileUrl": "https://example.com/document.pdf",
  "chunkSize": 1000,
  "overlapSize": 200
}
```

#### 自定义策略组合
```json
{
  "fileUrl": "https://example.com/document.pdf", 
  "chunkSize": 800,
  "overlapSize": 150,
  "chunkingStrategies": ["IMAGE_PROCESSING", "TEXT_CONTENT"]
}
```

#### 仅使用表格处理
```json
{
  "fileUrl": "https://example.com/data.xlsx",
  "chunkingStrategies": ["TABLE_PROCESSING"]
}
```

### 3. 文档类型默认策略

| 文档类型 | 默认策略组合 | 说明 |
|---------|-------------|------|
| PDF | IMAGE_PROCESSING + TEXT_CONTENT | 先提取图像，再处理文本 |
| HTML/HTM | IMAGE_PROCESSING + TABLE_PROCESSING + TEXT_CONTENT | 全面处理：图像+表格+文本 |
| XLSX/XLS/CSV | TABLE_PROCESSING | 专注表格数据处理 |
| MARKDOWN/MDX | IMAGE_PROCESSING + TEXT_CONTENT | 图像+文本处理 |
| DOCX | IMAGE_PROCESSING + TEXT_CONTENT | 图像+文本处理 |
| TXT | TEXT_CONTENT | 纯文本处理 |

### 4. 配置参数说明

#### 全局配置参数
- `chunkSize`: 分块大小（token数）
- `overlapSize`: 分块重叠大小
- `preserveMetadata`: 是否保留元数据
- `removeEmptyChunks`: 是否移除空分块
- `minChunkLength`: 最小分块长度

#### 策略特定配置

**TEXT_CONTENT策略**:
- `preserveSentences`: 是否保持句子完整性
- `chunkSize`: 文本块大小
- `overlapSize`: 重叠大小

**TABLE_PROCESSING策略**:
- `maxRowsPerChunk`: 每个分块最大行数
- `preserveHeaders`: 是否保留表头
- `extractTableContext`: 是否提取表格上下文

**IMAGE_PROCESSING策略**:
- `enableOCR`: 是否启用OCR识别
- `enableImageDescription`: 是否生成图像描述
- `extractImageMetadata`: 是否提取图像元数据
- `maxImageSize`: 最大处理图像大小

## 优势

### 1. 灵活性
- 支持策略自由组合
- 可根据文档特点定制处理流程
- 动态配置不同处理参数

### 2. 扩展性
- 新策略容易添加
- 现有策略可独立优化
- 支持复杂文档类型

### 3. 可维护性
- 清晰的架构分层
- 策略独立测试
- 配置驱动的行为

### 4. 向后兼容
- 保持现有API不变
- 自动回退到传统处理方式
- 渐进式迁移

## 实际应用场景

### 场景1：PDF技术文档处理
```json
{
  "fileUrl": "technical-manual.pdf",
  "chunkSize": 800,
  "chunkingStrategies": ["IMAGE_PROCESSING", "TABLE_PROCESSING", "TEXT_CONTENT"]
}
```
**处理流程**: 先提取和识别图表 → 处理数据表格 → 分割文本内容

### 场景2：Excel数据报告
```json
{
  "fileUrl": "sales-report.xlsx", 
  "chunkingStrategies": ["TABLE_PROCESSING"]
}
```
**处理流程**: 按工作表和行数智能分块，保留数据结构

### 场景3：网页内容爬取
```json
{
  "fileUrl": "webpage-content.html",
  "chunkingStrategies": ["IMAGE_PROCESSING", "TABLE_PROCESSING", "TEXT_CONTENT"]
}
```
**处理流程**: 提取图像信息 → 解析表格数据 → 分割正文内容

### 场景4：简单文本处理
```json
{
  "fileUrl": "article.txt",
  "chunkSize": 500,
  "overlapSize": 50
}
```
**处理流程**: 使用默认TEXT_CONTENT策略进行快速分块

## 性能考虑

1. **策略选择**: 根据文档类型自动选择最优策略组合
2. **并行处理**: 支持策略并行执行（需要策略支持）
3. **缓存机制**: 策略实例复用，减少创建开销
4. **回退机制**: 新架构失败时自动回退到传统方式

## 监控和统计

通过 `ChunkingStrategyRegistry.getStrategyStats()` 可以获取：
- 策略使用频率
- 文档类型处理统计
- 性能指标
- 错误率统计

## 测试

详细的单元测试位于：
`smartcs-web-app/src/test/java/com/leyue/smartcs/knowledge/chunking/ChunkingStrategyTest.java`

测试覆盖：
- 策略注册和发现
- 单个策略功能
- 管道组合执行
- 配置验证
- 错误处理

## 迁移建议

1. **阶段1**: 部署新架构，默认使用现有逻辑（已完成）
2. **阶段2**: 逐步启用新策略，监控效果
3. **阶段3**: 根据反馈优化策略参数
4. **阶段4**: 完全切换到新架构

新架构已实现向后兼容，可以安全部署和测试。