# 数据库异常处理改进说明

## 问题描述

在 smartcs-web 项目中，数据库查询异常被抛到前端时，前端收到的是不明确的"系统异常"信息，而不是具体的数据库错误信息。这导致：

1. 用户无法了解具体的错误原因
2. 开发人员难以快速定位问题
3. 缺乏对数据库异常的分类处理

## 解决方案

### 1. 增强全局异常处理器

在 `GlobalExceptionHandler.java` 中添加了对以下数据库相关异常的具体处理：

#### 1.1 SQL异常处理
- **SQLException**: 根据SQL状态码分类处理
- **SQLTimeoutException**: 数据库查询超时
- **SQLTransientException**: 可重试的临时异常
- **SQLNonTransientException**: 不可重试的永久异常

#### 1.2 Spring数据访问异常
- **DataAccessException**: 通用数据访问异常
- **BadSqlGrammarException**: SQL语法错误
- **UncategorizedSQLException**: 未分类的SQL异常

#### 1.3 数据完整性异常
- **DataIntegrityViolationException**: 数据完整性违反
- **DuplicateKeyException**: 重复键异常

#### 1.4 事务异常
- **TransactionException**: 事务异常
- **TransactionSystemException**: 事务系统异常

#### 1.5 MyBatis框架异常
- **PersistenceException**: MyBatis持久化异常
- **MybatisPlusException**: MyBatis-Plus异常

### 2. 异常分类与错误码

#### 2.1 连接相关异常
- `DB_CONNECTION_ERROR`: 数据库连接失败
- `DB_CONNECTION_LOST`: 数据库连接已断开
- `DB_CONNECTION_REFUSED`: 数据库连接被拒绝
- `DB_CONNECTION_ABORTED`: 数据库连接异常断开
- `DB_CONNECTION_POOL_ERROR`: 数据库连接池异常
- `DB_COMMUNICATION_ERROR`: 数据库通信失败

#### 2.2 语法和权限异常
- `DB_SYNTAX_ERROR`: 数据库查询语法错误
- `DB_PERMISSION_ERROR`: 数据库权限不足
- `DB_AUTH_ERROR`: 数据库认证失败

#### 2.3 数据约束异常
- `DB_CONSTRAINT_ERROR`: 数据约束违反
- `DB_FOREIGN_KEY_ERROR`: 外键约束违反
- `DB_UNIQUE_CONSTRAINT_ERROR`: 数据重复，违反唯一约束
- `DB_CHECK_CONSTRAINT_ERROR`: 数据检查约束违反
- `DB_INTEGRITY_ERROR`: 数据完整性违反
- `DB_DUPLICATE_KEY`: 数据重复，违反唯一约束

#### 2.4 数据操作异常
- `DB_INSERT_ERROR`: 数据插入格式错误
- `DB_COLUMN_MISMATCH`: 数据库列数不匹配
- `DB_DATA_TRUNCATED`: 数据长度超出限制
- `DB_NUMERIC_OVERFLOW`: 数值超出范围
- `DB_TYPE_MISMATCH`: 数据类型不匹配

#### 2.5 对象不存在异常
- `DB_TABLE_NOT_FOUND`: 数据库表不存在
- `DB_COLUMN_NOT_FOUND`: 数据库列不存在
- `DB_TABLE_UNDEFINED`: 数据库表未定义
- `DB_COLUMN_UNDEFINED`: 数据库列未定义
- `DB_OBJECT_UNDEFINED`: 数据库对象未定义
- `DB_FUNCTION_UNDEFINED`: 数据库函数未定义
- `DB_PARAMETER_UNDEFINED`: 数据库参数未定义

#### 2.6 其他异常
- `DB_TIMEOUT_ERROR`: 数据库查询超时
- `DB_TRANSIENT_ERROR`: 数据库临时异常，请稍后重试
- `DB_NON_TRANSIENT_ERROR`: 数据库永久异常
- `DB_TRANSACTION_ERROR`: 数据库事务异常
- `DB_TRANSACTION_SYSTEM_ERROR`: 数据库事务系统异常
- `DB_PERSISTENCE_ERROR`: 数据持久化异常
- `DB_MYBATIS_PLUS_ERROR`: 数据库操作异常
- `DB_ERROR`: 数据库操作异常（通用）

### 3. 安全考虑

#### 3.1 敏感信息过滤
- 避免SQL语句泄露到前端
- 避免数据库连接信息泄露
- 避免详细的错误堆栈信息泄露

#### 3.2 错误信息规范
- 生产环境：返回用户友好的错误信息
- 开发环境：可选择性显示详细错误信息
- 日志记录：详细记录异常堆栈信息用于问题排查

### 4. 使用示例

#### 4.1 前端接收到的错误响应
```json
{
  "success": false,
  "errCode": "DB_CONNECTION_ERROR",
  "errMessage": "数据库连接失败"
}
```

#### 4.2 测试用例
参考 `tests/DatabaseExceptionTest.java` 文件，包含了各种数据库异常的处理测试。

### 5. 改进效果

#### 5.1 用户体验提升
- 用户能够看到具体的错误原因
- 错误信息更加友好和明确
- 减少了用户困惑

#### 5.2 开发效率提升
- 开发人员能够快速定位问题
- 错误分类清晰，便于处理
- 测试覆盖更全面

#### 5.3 系统稳定性提升
- 异常处理更加完善
- 避免了敏感信息泄露
- 提供了更好的错误恢复机制

### 6. 注意事项

1. **异常处理顺序**: 具体的异常处理器应该在通用异常处理器之前
2. **错误码规范**: 使用统一的错误码前缀 `DB_`
3. **日志记录**: 所有异常都应该记录详细的日志信息
4. **测试覆盖**: 确保所有异常处理逻辑都有对应的测试用例

### 7. 后续优化建议

1. **监控告警**: 根据不同的异常类型设置不同的告警策略
2. **重试机制**: 对可重试的异常实现自动重试机制
3. **降级处理**: 对数据库异常实现服务降级策略
4. **性能优化**: 优化异常处理逻辑，减少性能影响 